{% extends 'base.html' %}

{% block title %}{{ title }} - CoC Bot{% endblock %}

{% block content %}
<h2>{{ title }}</h2>

<style>
    .stat-icon {
        font-size: 1.2em;
        vertical-align: middle;
    }
    .player-name {
        font-weight: bold;
        color: var(--bs-link-color);
        cursor: help;
    }

    /* CoC Sheet Styles */
    .coc-sheet {
        background-color: #1a1a1a;
        color: #e0e0e0;
        font-family: 'Courier New', Courier, monospace; /* Retro feel */
        border: 2px solid var(--cthulhu-green-dark);
        padding: 20px;
        border-radius: 5px;
    }

    .coc-header {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--cthulhu-green-dark);
        padding-bottom: 10px;
    }

    .coc-label {
        font-size: 0.8em;
        color: var(--cthulhu-green-main);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .coc-value {
        font-size: 1.1em;
        font-weight: bold;
        color: #fff;
        border-bottom: 1px dotted #444;
    }

    .coc-section-title {
        background-color: var(--cthulhu-green-dark);
        color: #fff;
        padding: 5px 10px;
        font-weight: bold;
        text-transform: uppercase;
        margin-top: 15px;
        margin-bottom: 10px;
        border-radius: 3px;
    }

    .coc-characteristics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 10px;
        text-align: center;
        margin-bottom: 20px;
    }

    .coc-stat-box {
        background: #0f0f0f;
        border: 1px solid #333;
        padding: 5px;
        border-radius: 5px;
    }

    .coc-stat-big {
        font-size: 1.4em;
        color: var(--cthulhu-green-bright);
    }

    .coc-status-bar {
        display: flex;
        justify-content: space-around;
        background: #222;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
        border: 1px solid #333;
    }

    .coc-skills-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 5px 15px;
    }

    .coc-skill-item {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border: 1px solid #333;
        background: #111;
        padding: 5px;
        border-radius: 4px;
        margin-bottom: 5px;
    }

    .coc-skill-row-1 {
        color: #bbb;
        font-size: 0.9em;
        margin-bottom: 2px;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        width: 100%;
    }

    .coc-skill-row-2 {
        font-family: 'Courier New', monospace;
    }

    .coc-skill-val-big {
        font-size: 1.2em;
        color: var(--cthulhu-green-bright);
        font-weight: bold;
    }

    .coc-skill-val-small {
        font-size: 0.8em;
        color: #666;
    }

</style>

{% if type == 'active' %}
    {% for server_id, users in data.items() %}
    <div class="card mb-4">
        <div class="card-header">Server ID: {{ server_id }}</div>
        <div class="card-body">
            <table class="table table-striped align-middle">
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Character</th>
                        <th>Occupation</th>
                        <th>View Sheet</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user_id, char in users.items() %}
                    <tr>
                        <td>
                            <span class="player-name" data-bs-toggle="tooltip" title="User ID: {{ user_id }}">
                                {{ user_names.get(user_id, user_id) }}
                            </span>
                        </td>
                        <td>{{ char.get('NAME', 'Unknown') }}</td>
                        <td>{{ char.get('Occupation', 'Unknown') }}</td>
                        <td>
                            <button class="btn btn-sm btn-primary me-1" data-bs-toggle="modal" data-bs-target="#modal-{{server_id}}-{{user_id}}">
                                <i class="bi bi-file-earmark-person"></i> View Sheet
                            </button>
                            {% if is_admin %}
                            <button class="btn btn-sm btn-danger"
                                    onclick='deleteCharacter({{ server_id|tojson }}, {{ user_id|tojson }}, "active", {{ char.get("NAME")|tojson }}, null)'
                                    aria-label="Delete {{ char.get('NAME') }}"
                                    data-bs-toggle="tooltip"
                                    title="Delete Character">
                                <i class="bi bi-trash"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>

                    <!-- Modal -->
                    <div class="modal fade" id="modal-{{server_id}}-{{user_id}}" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">{{ char.get('NAME') }}</h5>
                                    <div class="ms-auto">
                                        <button class="btn btn-sm btn-outline-success me-2" id="btn-copy-{{server_id}}-{{user_id}}" style="display:none;" onclick="copyJson('{{server_id}}-{{user_id}}')"><i class="bi bi-clipboard"></i> Copy JSON</button>
                                        <button class="btn btn-sm btn-outline-secondary me-2" id="btn-toggle-{{server_id}}-{{user_id}}" onclick="toggleJson('{{server_id}}-{{user_id}}')">Show JSON</button>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                </div>
                                <div class="modal-body">
                                    <!-- Sheet View -->
                                    <div id="sheet-{{server_id}}-{{user_id}}" class="char-sheet-container coc-sheet">

                                        <!-- Game Mode Header -->
                                        <div class="text-center mb-3" style="border-bottom: 2px solid var(--cthulhu-green-dark); padding-bottom: 10px;">
                                            <h4 style="color: var(--cthulhu-green-bright); font-family: 'Courier New', Courier, monospace; text-transform: uppercase;">
                                                {% if char.get('Game Mode') == 'Pulp of Cthulhu' or 'pulp' in (char.get('Game Mode')|default('')|lower) %}
                                                    Pulp of Cthulhu Character
                                                {% else %}
                                                    Call of Cthulhu Character
                                                {% endif %}
                                            </h4>
                                        </div>

                                        <!-- Bio Header -->
                                        <div class="coc-header">
                                            <div>
                                                <div class="coc-label">Name</div>
                                                <div class="coc-value">{{ char.get('NAME', 'Unknown') }}</div>
                                            </div>
                                            <div>
                                                <div class="coc-label">Occupation</div>
                                                <div class="coc-value">{{ char.get('Occupation', 'Unknown') }}</div>
                                            </div>
                                            <div>
                                                <div class="coc-label">Age</div>
                                                <div class="coc-value">{{ char.get('Age', '') }}</div>
                                            </div>
                                            <div>
                                                <div class="coc-label">Residence</div>
                                                <div class="coc-value">{{ char.get('Residence', 'Unknown') }}</div>
                                            </div>
                                        </div>

                                        <!-- Characteristics -->
                                        <div class="coc-section-title">Characteristics</div>
                                        <div class="coc-characteristics">
                                            {% for stat in ['STR', 'DEX', 'INT', 'CON', 'APP', 'POW', 'SIZ', 'EDU'] %}
                                            <div class="coc-stat-box">
                                                <div class="coc-label">{{ stat }}</div>
                                                <div class="coc-stat-big">
                                                    {{ emojis.get_stat_emoji(stat) | format_custom_emoji | safe }}
                                                    {{ char.get(stat, 0) }}
                                                </div>
                                                <div style="font-size:0.7em; color:#666;">{{ char.get(stat,0)|int // 2 }} / {{ char.get(stat,0)|int // 5 }}</div>
                                            </div>
                                            {% endfor %}
                                        </div>

                                        <!-- Status -->
                                        <div class="coc-section-title">Status</div>
                                        <div class="coc-status-bar">
                                            <div class="text-center">
                                                <div class="coc-label">Hit Points</div>
                                                <div class="coc-stat-big text-danger">
                                                    {{ emojis.get_stat_emoji('HP') | format_custom_emoji | safe }} {{ char.get('HP') }}
                                                </div>
                                            </div>
                                            <div class="text-center">
                                                <div class="coc-label">Sanity</div>
                                                <div class="coc-stat-big text-warning">
                                                    {{ emojis.get_stat_emoji('SAN') | format_custom_emoji | safe }} {{ char.get('SAN') }}
                                                </div>
                                            </div>
                                            <div class="text-center">
                                                <div class="coc-label">Magic Points</div>
                                                <div class="coc-stat-big text-info">
                                                    {{ emojis.get_stat_emoji('MP') | format_custom_emoji | safe }} {{ char.get('MP') }}
                                                </div>
                                            </div>
                                            <div class="text-center">
                                                <div class="coc-label">Luck</div>
                                                <div class="coc-stat-big text-success">
                                                    {{ emojis.get_stat_emoji('LUCK') | format_custom_emoji | safe }} {{ char.get('LUCK') }}
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Combat & Move -->
                                        <div class="row mb-3">
                                            <div class="col-md-3">
                                                <div class="coc-stat-box">
                                                    <div class="coc-label">Move</div>
                                                    <div>{{ char.get('Move') }}</div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="coc-stat-box">
                                                    <div class="coc-label">Build</div>
                                                    <div>{{ char.get('Build') }}</div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="coc-stat-box">
                                                    <div class="coc-label">Dmg Bonus</div>
                                                    <div>{{ char.get('Damage Bonus') }}</div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="coc-stat-box">
                                                    <div class="coc-label">Dodge</div>
                                                    <div>{{ char.get('Dodge') }}</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Skills -->
                                        <div class="coc-section-title">Skills</div>
                                        <div class="coc-skills-grid">
                                            {% set excluded = ['STR', 'DEX', 'INT', 'CON', 'APP', 'POW', 'SIZ', 'EDU',
                                                               'HP', 'MP', 'SAN', 'LUCK', 'Move', 'Build', 'Damage Bonus', 'Dodge',
                                                               'NAME', 'Occupation', 'Age', 'Sex', 'Residence', 'Birthplace',
                                                               'Credit Rating', 'Archetype', 'Archetype Info', 'Talent', 'Backstory'] %}

                                            <!-- Explicit Credit Rating first -->
                                            <div class="coc-skill-item">
                                                <div class="coc-skill-row-1">
                                                    {{ emojis.get_stat_emoji('Credit Rating') | format_custom_emoji | safe }} Credit Rating
                                                </div>
                                                <div class="coc-skill-row-2">
                                                    <span class="coc-skill-val-big">{{ char.get('Credit Rating', 0) }}</span>
                                                    <span class="coc-skill-val-small">| {{ char.get('Credit Rating', 0)|int // 2 }} | {{ char.get('Credit Rating', 0)|int // 5 }}</span>
                                                </div>
                                            </div>

                                            {% for key, val in char.items()|sort %}
                                                {% if key not in excluded and key|length > 0 %}
                                                    {# Filter out likely non-skills based on capitalization? CoC skills are usually Capitalized #}
                                                    {# Also check if value is a number #}
                                                    {% if val is number or val|string|replace('.','',1)|int(-1) != -1 %}
                                                    <div class="coc-skill-item">
                                                        <div class="coc-skill-row-1">
                                                            {{ emojis.get_stat_emoji(key) | format_custom_emoji | safe }} {{ key }}
                                                        </div>
                                                        <div class="coc-skill-row-2">
                                                            <span class="coc-skill-val-big">{{ val }}</span>
                                                            <span class="coc-skill-val-small">| {{ val|int // 2 }} | {{ val|int // 5 }}</span>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        </div>

                                        <!-- Background & Details -->
                                        <div class="coc-section-title">Background & Details</div>
                                        <div class="row">
                                            {% if char.get('Archetype') %}
                                                <div class="col-12 mb-3">
                                                    <div class="coc-label" style="font-size: 1em; border-bottom: 1px solid #333; margin-bottom: 5px;">Archetype</div>
                                                    <p class="text-white small mb-1">{{ char.get('Archetype') }}</p>
                                                    {% if char.get('Archetype Info') %}
                                                        {% set a_info = char.get('Archetype Info') %}
                                                        {% if a_info.get('adjustments') %}
                                                            <div class="mt-2">
                                                            {% for adj in a_info.get('adjustments') %}
                                                                <p class="text-white small mb-0">• {{ adj | format_custom_emoji | format_bold | safe }}</p>
                                                            {% endfor %}
                                                            </div>
                                                        {% endif %}
                                                    {% endif %}
                                                </div>
                                            {% endif %}

                                            {% set backstory_order = [
                                                'Pulp Talents',
                                                'My Story', 'Personal Description', 'Ideology and Beliefs',
                                                'Significant People', 'Meaningful Locations', 'Treasured Possessions',
                                                'Traits', 'Injuries and Scars', 'Phobias and Manias',
                                                'Arcane Tome and Spells', 'Encounters with Strange Entities',
                                                'Fellow Investigators', 'Gear and Possessions',
                                                'Spending Level', 'Cash', 'Assets'
                                            ] %}
                                            {% set char_backstory = char.get('Backstory', {}) %}

                                            {% for section in backstory_order %}
                                                {% if section in char_backstory %}
                                                    <div class="col-12 mb-3">
                                                        <div class="coc-label" style="font-size: 1em; border-bottom: 1px solid #333; margin-bottom: 5px;">{{ section }}</div>
                                                        {% set entries = char_backstory[section] %}
                                                        {% if entries and entries|length > 0 %}
                                                            {% for entry in entries %}
                                                                <p class="text-white small mb-1">{{ entry | format_custom_emoji | format_bold | safe }}</p>
                                                            {% endfor %}
                                                        {% else %}
                                                            <div class="text-white small" style="min-height: 1.2em;">&nbsp;</div>
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}

                                            {% for key, val in char.items()|sort %}
                                                {% if key not in excluded and key|length > 0 %}
                                                    {% if not (val is number or val|string|replace('.','',1)|int(-1) != -1) %}
                                                    <div class="col-md-6 mb-2">
                                                        <div class="coc-label">{{ key }}</div>
                                                        <div class="text-white small" style="white-space: pre-wrap;">{{ val | format_custom_emoji | safe }}</div>
                                                    </div>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>

                                    <!-- JSON View -->
                                    <div id="json-{{server_id}}-{{user_id}}" style="display: none;">
                                        <pre>{{ char | tojson(indent=4) }}</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endfor %}
{% elif type == 'retired' %}
    <table class="table table-striped align-middle">
        <thead>
            <tr>
                <th>Player</th>
                <th>Character</th>
                <th>Occupation</th>
                <th>View Sheet</th>
            </tr>
        </thead>
        <tbody>
            {% for user_id, char_list in data.items() %}
                {% for char in char_list %}
                <tr>
                    <td>
                        <span class="player-name" data-bs-toggle="tooltip" title="User ID: {{ user_id }}">
                            {{ user_names.get(user_id, user_id) }}
                        </span>
                    </td>
                    <td>{{ char.get('NAME', 'Unknown') }}</td>
                    <td>{{ char.get('Occupation', 'Unknown') }}</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1" data-bs-toggle="modal" data-bs-target="#modal-ret-{{user_id}}-{{loop.index}}">
                            <i class="bi bi-file-earmark-person"></i> View Sheet
                        </button>
                        {% if is_admin %}
                        <button class="btn btn-sm btn-danger"
                                onclick='deleteCharacter(null, {{ user_id|tojson }}, "retired", {{ char.get("NAME")|tojson }}, {{ loop.index0 }})'
                                aria-label="Delete {{ char.get('NAME') }}"
                                data-bs-toggle="tooltip"
                                title="Delete Character">
                            <i class="bi bi-trash"></i>
                        </button>
                        {% endif %}
                    </td>
                </tr>

                <!-- Modal -->
                <div class="modal fade" id="modal-ret-{{user_id}}-{{loop.index}}" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">{{ char.get('NAME') }} (Retired)</h5>
                                <div class="ms-auto">
                                    <button class="btn btn-sm btn-outline-success me-2" id="btn-copy-ret-{{user_id}}-{{loop.index}}" style="display:none;" onclick="copyJson('ret-{{user_id}}-{{loop.index}}')"><i class="bi bi-clipboard"></i> Copy JSON</button>
                                    <button class="btn btn-sm btn-outline-secondary me-2" id="btn-toggle-ret-{{user_id}}-{{loop.index}}" onclick="toggleJson('ret-{{user_id}}-{{loop.index}}')">Show JSON</button>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                            </div>
                            <div class="modal-body">
                                 <!-- Sheet View -->
                                 <div id="sheet-ret-{{user_id}}-{{loop.index}}" class="char-sheet-container coc-sheet">

                                        <!-- Game Mode Header -->
                                        <div class="text-center mb-3" style="border-bottom: 2px solid var(--cthulhu-green-dark); padding-bottom: 10px;">
                                            <h4 style="color: var(--cthulhu-green-bright); font-family: 'Courier New', Courier, monospace; text-transform: uppercase;">
                                                {% if char.get('Game Mode') == 'Pulp of Cthulhu' or 'pulp' in (char.get('Game Mode')|default('')|lower) %}
                                                    Pulp of Cthulhu Character
                                                {% else %}
                                                    Call of Cthulhu Character
                                                {% endif %}
                                            </h4>
                                        </div>

                                        <!-- Bio Header -->
                                        <div class="coc-header">
                                            <div>
                                                <div class="coc-label">Name</div>
                                                <div class="coc-value">{{ char.get('NAME', 'Unknown') }}</div>
                                            </div>
                                            <div>
                                                <div class="coc-label">Occupation</div>
                                                <div class="coc-value">{{ char.get('Occupation', 'Unknown') }}</div>
                                            </div>
                                            <div>
                                                <div class="coc-label">Age</div>
                                                <div class="coc-value">{{ char.get('Age', '') }}</div>
                                            </div>
                                            <div>
                                                <div class="coc-label">Residence</div>
                                                <div class="coc-value">{{ char.get('Residence', 'Unknown') }}</div>
                                            </div>
                                        </div>

                                        <!-- Characteristics -->
                                        <div class="coc-section-title">Characteristics</div>
                                        <div class="coc-characteristics">
                                            {% for stat in ['STR', 'DEX', 'INT', 'CON', 'APP', 'POW', 'SIZ', 'EDU'] %}
                                            <div class="coc-stat-box">
                                                <div class="coc-label">{{ stat }}</div>
                                                <div class="coc-stat-big">
                                                    {{ emojis.get_stat_emoji(stat) | format_custom_emoji | safe }}
                                                    {{ char.get(stat, 0) }}
                                                </div>
                                                <div style="font-size:0.7em; color:#666;">{{ char.get(stat,0)|int // 2 }} / {{ char.get(stat,0)|int // 5 }}</div>
                                            </div>
                                            {% endfor %}
                                        </div>

                                        <!-- Status -->
                                        <div class="coc-section-title">Status</div>
                                        <div class="coc-status-bar">
                                            <div class="text-center">
                                                <div class="coc-label">Hit Points</div>
                                                <div class="coc-stat-big text-danger">
                                                    {{ emojis.get_stat_emoji('HP') | format_custom_emoji | safe }} {{ char.get('HP') }}
                                                </div>
                                            </div>
                                            <div class="text-center">
                                                <div class="coc-label">Sanity</div>
                                                <div class="coc-stat-big text-warning">
                                                    {{ emojis.get_stat_emoji('SAN') | format_custom_emoji | safe }} {{ char.get('SAN') }}
                                                </div>
                                            </div>
                                            <div class="text-center">
                                                <div class="coc-label">Magic Points</div>
                                                <div class="coc-stat-big text-info">
                                                    {{ emojis.get_stat_emoji('MP') | format_custom_emoji | safe }} {{ char.get('MP') }}
                                                </div>
                                            </div>
                                            <div class="text-center">
                                                <div class="coc-label">Luck</div>
                                                <div class="coc-stat-big text-success">
                                                    {{ emojis.get_stat_emoji('LUCK') | format_custom_emoji | safe }} {{ char.get('LUCK') }}
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Combat & Move -->
                                        <div class="row mb-3">
                                            <div class="col-md-3">
                                                <div class="coc-stat-box">
                                                    <div class="coc-label">Move</div>
                                                    <div>{{ char.get('Move') }}</div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="coc-stat-box">
                                                    <div class="coc-label">Build</div>
                                                    <div>{{ char.get('Build') }}</div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="coc-stat-box">
                                                    <div class="coc-label">Dmg Bonus</div>
                                                    <div>{{ char.get('Damage Bonus') }}</div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="coc-stat-box">
                                                    <div class="coc-label">Dodge</div>
                                                    <div>{{ char.get('Dodge') }}</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Skills -->
                                        <div class="coc-section-title">Skills</div>
                                        <div class="coc-skills-grid">
                                            {% set excluded = ['STR', 'DEX', 'INT', 'CON', 'APP', 'POW', 'SIZ', 'EDU',
                                                               'HP', 'MP', 'SAN', 'LUCK', 'Move', 'Build', 'Damage Bonus', 'Dodge',
                                                               'NAME', 'Occupation', 'Age', 'Sex', 'Residence', 'Birthplace',
                                                               'Credit Rating', 'Archetype', 'Archetype Info', 'Talent', 'Backstory'] %}

                                            <!-- Explicit Credit Rating first -->
                                            <div class="coc-skill-item">
                                                <div class="coc-skill-row-1">
                                                    {{ emojis.get_stat_emoji('Credit Rating') | format_custom_emoji | safe }} Credit Rating
                                                </div>
                                                <div class="coc-skill-row-2">
                                                    <span class="coc-skill-val-big">{{ char.get('Credit Rating', 0) }}</span>
                                                    <span class="coc-skill-val-small">| {{ char.get('Credit Rating', 0)|int // 2 }} | {{ char.get('Credit Rating', 0)|int // 5 }}</span>
                                                </div>
                                            </div>

                                            {% for key, val in char.items()|sort %}
                                                {% if key not in excluded and key|length > 0 %}
                                                    {# Filter out likely non-skills based on capitalization? CoC skills are usually Capitalized #}
                                                    {# Also check if value is a number #}
                                                    {% if val is number or val|string|replace('.','',1)|int(-1) != -1 %}
                                                    <div class="coc-skill-item">
                                                        <div class="coc-skill-row-1">
                                                            {{ emojis.get_stat_emoji(key) | format_custom_emoji | safe }} {{ key }}
                                                        </div>
                                                        <div class="coc-skill-row-2">
                                                            <span class="coc-skill-val-big">{{ val }}</span>
                                                            <span class="coc-skill-val-small">| {{ val|int // 2 }} | {{ val|int // 5 }}</span>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        </div>

                                        <!-- Background & Details -->
                                        <div class="coc-section-title">Background & Details</div>
                                        <div class="row">
                                            {% if char.get('Archetype') %}
                                                <div class="col-12 mb-3">
                                                    <div class="coc-label" style="font-size: 1em; border-bottom: 1px solid #333; margin-bottom: 5px;">Archetype</div>
                                                    <p class="text-white small mb-1">{{ char.get('Archetype') }}</p>
                                                    {% if char.get('Archetype Info') %}
                                                        {% set a_info = char.get('Archetype Info') %}
                                                        {% if a_info.get('adjustments') %}
                                                            <div class="mt-2">
                                                            {% for adj in a_info.get('adjustments') %}
                                                                <p class="text-white small mb-0">• {{ adj | format_custom_emoji | format_bold | safe }}</p>
                                                            {% endfor %}
                                                            </div>
                                                        {% endif %}
                                                    {% endif %}
                                                </div>
                                            {% endif %}

                                            {% set backstory_order = [
                                                'Pulp Talents',
                                                'My Story', 'Personal Description', 'Ideology and Beliefs',
                                                'Significant People', 'Meaningful Locations', 'Treasured Possessions',
                                                'Traits', 'Injuries and Scars', 'Phobias and Manias',
                                                'Arcane Tome and Spells', 'Encounters with Strange Entities',
                                                'Fellow Investigators', 'Gear and Possessions',
                                                'Spending Level', 'Cash', 'Assets'
                                            ] %}
                                            {% set char_backstory = char.get('Backstory', {}) %}

                                            {% for section in backstory_order %}
                                                {% if section in char_backstory %}
                                                    <div class="col-12 mb-3">
                                                        <div class="coc-label" style="font-size: 1em; border-bottom: 1px solid #333; margin-bottom: 5px;">{{ section }}</div>
                                                        {% set entries = char_backstory[section] %}
                                                        {% if entries and entries|length > 0 %}
                                                            {% for entry in entries %}
                                                                <p class="text-white small mb-1">{{ entry | format_custom_emoji | format_bold | safe }}</p>
                                                            {% endfor %}
                                                        {% else %}
                                                            <div class="text-white small" style="min-height: 1.2em;">&nbsp;</div>
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}

                                            {% for key, val in char.items()|sort %}
                                                {% if key not in excluded and key|length > 0 %}
                                                    {% if not (val is number or val|string|replace('.','',1)|int(-1) != -1) %}
                                                    <div class="col-md-6 mb-2">
                                                        <div class="coc-label">{{ key }}</div>
                                                        <div class="text-white small" style="white-space: pre-wrap;">{{ val | format_custom_emoji | safe }}</div>
                                                    </div>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>

                                <!-- JSON View -->
                                <div id="json-ret-{{user_id}}-{{loop.index}}" style="display: none;">
                                    <pre>{{ char | tojson(indent=4) }}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>
{% endif %}

<script>
    async function deleteCharacter(server_id, user_id, type, char_name, index) {
        var confirmation = prompt("To DELETE character '" + char_name + "', please type their name below:\nThis action cannot be undone.");

        if (confirmation === char_name) {
            try {
                const response = await fetch('/api/character/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        server_id: server_id,
                        user_id: user_id,
                        type: type,
                        name: confirmation,
                        index: index
                    })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    alert('Character deleted successfully.');
                    window.location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while deleting the character.');
            }
        } else if (confirmation !== null) {
            alert("Name did not match. Deletion cancelled.");
        }
    }

    function toggleJson(id) {
        var sheet = document.getElementById('sheet-' + id);
        var json = document.getElementById('json-' + id);
        var btn = document.getElementById('btn-toggle-' + id);
        var btnCopy = document.getElementById('btn-copy-' + id);

        if (sheet.style.display === 'none') {
            sheet.style.display = 'block';
            json.style.display = 'none';
            btn.innerText = 'Show JSON';
            if (btnCopy) btnCopy.style.display = 'none';
        } else {
            sheet.style.display = 'none';
            json.style.display = 'block';
            btn.innerText = 'Show Sheet';
            if (btnCopy) btnCopy.style.display = 'inline-block';
        }
    }

    function copyJson(id) {
        var jsonContent = document.querySelector('#json-' + id + ' pre').innerText;
        navigator.clipboard.writeText(jsonContent).then(function() {
            var btn = document.getElementById('btn-copy-' + id);
            var originalHtml = btn.innerHTML;

            btn.classList.remove('btn-outline-success');
            btn.classList.add('btn-success');
            btn.innerHTML = '<i class="bi bi-check-lg"></i> Copied!';

            setTimeout(function() {
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-success');
                btn.innerHTML = originalHtml;
            }, 2000);
        }, function(err) {
            console.error('Async: Could not copy text: ', err);
            alert('Failed to copy JSON to clipboard.');
        });
    }

    // Initialize Tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
</script>

{% endblock %}
