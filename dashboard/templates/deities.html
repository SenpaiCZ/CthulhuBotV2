{% extends 'base.html' %}

{% block title %}Deities - CoC Bot{% endblock %}

{% block content %}
<style>
    /* Custom layout for sidebar + content */
    .dashboard-container {
        display: flex;
        height: calc(100vh - 100px); /* Adjust for navbar */
        gap: 20px;
        padding-bottom: 20px;
    }

    /* Sidebar */
    .sidebar-panel {
        width: 300px;
        min-width: 300px;
        display: flex;
        flex-direction: column;
    }

    .sidebar-list {
        overflow-y: auto;
        flex-grow: 1;
        border: 1px solid var(--bs-border-color);
        border-radius: 0 0 var(--bs-border-radius) var(--bs-border-radius);
    }

    .list-group-item.active {
        background-color: var(--cthulhu-green-main);
        border-color: var(--cthulhu-green-main);
    }

    .list-group-item:hover {
        background-color: rgba(46, 139, 87, 0.1); /* Subtle green hover */
        color: var(--cthulhu-green-bright);
    }

    /* Main View */
    .detail-panel {
        flex: 1;
        overflow-y: auto;
        border: 1px solid var(--bs-border-color);
        background-color: var(--cthulhu-bg-card);
        border-radius: var(--bs-border-radius);
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    /* Custom scrollbars */
    .sidebar-list::-webkit-scrollbar,
    .detail-panel::-webkit-scrollbar {
        width: 8px;
    }
    .sidebar-list::-webkit-scrollbar-track,
    .detail-panel::-webkit-scrollbar-track {
        background: #0a0a0a;
    }
    .sidebar-list::-webkit-scrollbar-thumb,
    .detail-panel::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 4px;
    }
    .sidebar-list::-webkit-scrollbar-thumb:hover,
    .detail-panel::-webkit-scrollbar-thumb:hover {
        background: var(--cthulhu-green-main);
    }

    /* Typography tweaks */
    h1, h2, h3, h4, h5, h6 {
        color: var(--cthulhu-green-main);
    }

    .stat-box {
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--bs-border-color);
        border-radius: 4px;
        padding: 10px;
        text-align: center;
    }

    .stat-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        color: var(--bs-secondary);
        font-weight: bold;
    }

    .stat-value {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--bs-body-color);
    }

    .section-header {
        border-bottom: 1px solid var(--bs-border-color);
        padding-bottom: 5px;
        margin-bottom: 15px;
        margin-top: 25px;
        color: var(--cthulhu-green-bright);
        font-weight: 500;
        font-size: 1.2rem;
    }

    .quote-block {
        font-style: italic;
        border-left: 3px solid var(--cthulhu-green-main);
        background: rgba(46, 139, 87, 0.05);
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 0 4px 4px 0;
        color: var(--bs-secondary);
    }

    .hidden { display: none !important; }
</style>

<div class="container-fluid dashboard-container">
    <div class="sidebar-panel">
        <div class="card-header bg-dark text-white p-2 text-center border border-secondary border-bottom-0 rounded-top">
            <h5 class="m-0 text-success">Pantheon</h5>
        </div>
        <div class="list-group list-group-flush sidebar-list bg-dark" id="monsterList">
            {% if data and data.deities %}
                {% for item in data.deities %}
                    {% set d = item.deity_entry %}
                    <button type="button" class="list-group-item list-group-item-action bg-dark text-light border-secondary monster-list-item" onclick="showDeity({{ loop.index0 }})">
                        {{ d.name }}
                    </button>
                {% endfor %}
            {% else %}
                <div class="p-3 text-center text-muted">No deities found.</div>
            {% endif %}
        </div>
    </div>

    <div class="detail-panel" id="detailPanel">
        <div id="monster-placeholder" class="text-center d-flex flex-column justify-content-center h-100">
            <h2 class="text-muted" style="opacity: 0.3;">Select a Deity</h2>
            <p class="text-secondary">Explore the cosmic entities.</p>
        </div>

        <div id="monster-content" class="hidden">
            <!-- Content populated by JS -->
        </div>
    </div>
</div>

<script>
    const deities = {{ data.deities | tojson }};

    function showDeity(index) {
        try {
            const d = deities[index].deity_entry;
            const container = document.getElementById('monster-content');
            const placeholder = document.getElementById('monster-placeholder');

            // Highlight active item
            document.querySelectorAll('.monster-list-item').forEach((el, i) => {
                if(i === index) el.classList.add('active');
                else el.classList.remove('active');
            });

            // Physical Manifestation Check
            const pm = d.physical_manifestation || {};
            const chars = pm.characteristics || {};
            const combat = pm.combat || {};
            const armor = pm.armor || {};

            let html = `
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h1 class="display-5 mb-0 text-success">${d.name}</h1>
                        <div class="text-secondary fst-italic fs-5">${d.classification || 'Unknown Entity'}</div>
                    </div>
                    <div class="text-end">
                        ${(d.other_names || []).map(name => `<span class="badge bg-secondary me-1">${name}</span>`).join('')}
                    </div>
                </div>

                ${d.description_quote ? `<div class="quote-block">"${d.description_quote}"</div>` : ''}

                <div class="card bg-dark border-secondary mb-4">
                    <div class="card-body">
                        ${d.main_entry_text ? `<p class="card-text text-light">${d.main_entry_text}</p>` : '<em class="text-muted">No main entry text available.</em>'}
                    </div>
                </div>

                <div class="row g-4">
                    <!-- Cult Column -->
                    <div class="col-lg-6">
                        <div class="card border-secondary bg-dark h-100">
                            <div class="card-header border-secondary bg-transparent text-success fw-bold">Cult & Worship</div>
                            <div class="card-body">
                                ${d.cult ? `
                                    <p class="card-text small text-secondary">${d.cult.text || ''}</p>
                                    ${d.cult.possible_blessings ? `
                                        <hr class="border-secondary">
                                        <h6 class="card-subtitle mb-2 text-muted small text-uppercase">Possible Blessings</h6>
                                        <ul class="list-unstyled mb-0">
                                            ${d.cult.possible_blessings.map(b => `<li class="mb-2"><strong class="text-success">${b.name}:</strong> <span class="text-secondary small">${b.description}</span></li>`).join('')}
                                        </ul>
                                    ` : ''}
                                ` : '<p class="text-muted">No cult information.</p>'}
                            </div>
                        </div>
                    </div>

                    <!-- Encounters & Magic Column -->
                    <div class="col-lg-6">
                        <div class="card border-secondary bg-dark mb-3">
                            <div class="card-header border-secondary bg-transparent text-success fw-bold">Encounters & Aura</div>
                            <div class="card-body">
                                <p class="mb-1"><strong class="text-light">Encounters:</strong> <span class="text-muted">${d.encounters || 'None detailed.'}</span></p>
                                <p class="mb-0"><strong class="text-light">Aura:</strong> <span class="text-muted">${d.aura || 'None detailed.'}</span></p>
                            </div>
                        </div>

                        <div class="card border-secondary bg-dark">
                             <div class="card-header border-secondary bg-transparent text-success fw-bold">Magic & Powers</div>
                             <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-4 text-center border-end border-secondary">
                                        <div class="small text-muted">POW</div>
                                        <div class="fw-bold text-light">${d.magic ? d.magic.pow : 'N/A'}</div>
                                    </div>
                                    <div class="col-4 text-center border-end border-secondary">
                                        <div class="small text-muted">MP</div>
                                        <div class="fw-bold text-info">${d.magic ? d.magic.magic_points : 'N/A'}</div>
                                    </div>
                                    <div class="col-4 text-center">
                                        <div class="small text-muted">Sanity</div>
                                        <div class="fw-bold text-danger">${d.sanity_loss || 'N/A'}</div>
                                    </div>
                                </div>
                                <p class="small text-secondary mb-2"><strong>Spells:</strong> ${d.magic ? d.magic.spells : 'None'}</p>
                                ${d.powers ? `
                                    <h6 class="text-muted small text-uppercase mt-3">Special Powers</h6>
                                    <ul class="list-unstyled mb-0 small">
                                        ${d.powers.map(p => `<li class="mb-1"><strong class="text-warning">${p.name}:</strong> <span class="text-muted">${p.description}</span></li>`).join('')}
                                    </ul>
                                ` : ''}
                             </div>
                        </div>
                    </div>
                </div>

                <!-- Physical Manifestation Section -->
                <div class="section-header">Physical Manifestation <span class="fs-6 text-muted ms-2 fw-normal">${pm.title || ''}</span></div>

                <div class="row row-cols-4 row-cols-md-8 g-2 mb-4">
                    <div class="col"><div class="stat-box"><div class="stat-label">STR</div><div class="stat-value">${chars.STR || '-'}</div></div></div>
                    <div class="col"><div class="stat-box"><div class="stat-label">CON</div><div class="stat-value">${chars.CON || '-'}</div></div></div>
                    <div class="col"><div class="stat-box"><div class="stat-label">SIZ</div><div class="stat-value">${chars.SIZ || '-'}</div></div></div>
                    <div class="col"><div class="stat-box"><div class="stat-label">DEX</div><div class="stat-value">${chars.DEX || '-'}</div></div></div>
                    <div class="col"><div class="stat-box"><div class="stat-label">HP</div><div class="stat-value text-danger">${chars.HP || '-'}</div></div></div>
                    <div class="col"><div class="stat-box"><div class="stat-label">DB</div><div class="stat-value">${chars.DB || '-'}</div></div></div>
                    <div class="col"><div class="stat-box"><div class="stat-label">Build</div><div class="stat-value">${chars.Build || '-'}</div></div></div>
                    <div class="col"><div class="stat-box"><div class="stat-label">Move</div><div class="stat-value">${chars.Move || '-'}</div></div></div>
                </div>

                <div class="row">
                    <div class="col-md-7">
                        <h6 class="text-success fw-bold">Combat Capabilities</h6>
                        <p class="small text-muted mb-2">${combat.description || ''}</p>
                        <p class="mb-2"><span class="fw-bold text-light">Attacks per round:</span> ${combat.attacks_per_round || 'N/A'}</p>

                        ${combat.attacks ? `
                            <div class="list-group list-group-flush border rounded border-secondary mb-3">
                                ${combat.attacks.map(atk => `
                                    <div class="list-group-item bg-dark border-secondary">
                                        <div class="d-flex justify-content-between">
                                            <strong class="text-light">${atk.name}</strong>
                                            <span class="text-danger fw-bold">${atk.damage || ''}</span>
                                        </div>
                                        <div class="small text-secondary">Success: ${atk.success_chance || ''}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <div class="col-md-5">
                        ${combat.special_maneuvers ? `
                            <h6 class="text-success fw-bold">Special Maneuvers</h6>
                            <ul class="list-group list-group-flush bg-transparent mb-3">
                                ${combat.special_maneuvers.map(sm => `<li class="list-group-item bg-transparent border-0 px-0 py-1"><strong class="text-warning">${sm.name}:</strong> <span class="text-secondary small">${sm.description}</span></li>`).join('')}
                            </ul>
                        ` : ''}

                        <div class="card bg-secondary bg-opacity-10 border-secondary">
                            <div class="card-body py-2">
                                <div class="small text-uppercase text-success fw-bold">Armor</div>
                                <div class="fs-5 fw-bold text-light">${armor.rating || 'None'}</div>
                                <div class="small text-muted">${armor.notes || ''}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            container.classList.remove('hidden');
            placeholder.style.setProperty('display', 'none', 'important');
            placeholder.classList.remove('d-flex');

            document.getElementById('detailPanel').scrollTop = 0;

        } catch (e) {
            console.error(e);
            alert("Error rendering deity: " + e.message);
        }
    }
</script>
{% endblock %}
