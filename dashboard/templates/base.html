<!DOCTYPE html>
<html lang="en" data-bs-theme="dark" data-theme="{{ dashboard_theme|default('cthulhu') }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CoC Bot Dashboard{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/themes.css') }}" rel="stylesheet">

    {% include 'includes/font_styles.html' %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <a href="#main-content" class="visually-hidden-focusable position-absolute p-3 bg-dark text-white" style="z-index: 2000; left: 0; top: 0;">Skip to main content</a>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">CoC Bot</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                </ul>
                <ul class="navbar-nav">
                    {% if is_admin %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="keeperDropdown" role="button" data-bs-toggle="dropdown">
                            Keeper Tools
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li class="dropstart">
                                <a class="dropdown-item dropdown-toggle" href="#" data-bs-toggle="dropdown">Characters</a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="/characters">Active Characters</a></li>
                                    <li><a class="dropdown-item" href="/retired">Retired Characters</a></li>
                                </ul>
                            </li>
                            <li class="dropstart">
                                <a class="dropdown-item dropdown-toggle" href="#" data-bs-toggle="dropdown">Grimoire</a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="/monsters">Monsters</a></li>
                                    <li><a class="dropdown-item" href="/deities">Deities</a></li>
                                    <li><a class="dropdown-item" href="/spells">Spells</a></li>
                                </ul>
                            </li>
                            <li class="dropstart">
                                <a class="dropdown-item dropdown-toggle" href="#" data-bs-toggle="dropdown">Pulp</a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="/archetypes">Archetypes</a></li>
                                    <li><a class="dropdown-item" href="/pulp_talents">Talents</a></li>
                                    <li><a class="dropdown-item" href="/insane_talents">Insane Talents</a></li>
                                </ul>
                            </li>
                            <li class="dropstart">
                                <a class="dropdown-item dropdown-toggle" href="#" data-bs-toggle="dropdown">Reference</a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="/occupations">Occupations</a></li>
                                    <li><a class="dropdown-item" href="/skills">Skills</a></li>
                                    <li><a class="dropdown-item" href="/inventions">Inventions</a></li>
                                    <li><a class="dropdown-item" href="/years">Years</a></li>
                                    <li><a class="dropdown-item" href="/manias">Mania</a></li>
                                    <li><a class="dropdown-item" href="/phobias">Phobia</a></li>
                                    <li><a class="dropdown-item" href="/weapons">Weapons</a></li>
                                    <li><a class="dropdown-item" href="/poisons">Poisons</a></li>
                                </ul>
                            </li>
                            <li class="dropstart">
                                <a class="dropdown-item dropdown-toggle" href="#" data-bs-toggle="dropdown">Administration</a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="/admin/game_settings">Game Settings</a></li>
                                    <li><a class="dropdown-item" href="/admin/browse/infodata">Info Data</a></li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="audioDropdown" role="button" data-bs-toggle="dropdown">
                            Audio
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/admin/soundboard">Soundboard</a></li>
                            <li><a class="dropdown-item" href="/admin/music">Music Bot</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="serverAdminDropdown" role="button" data-bs-toggle="dropdown">
                            Server Administration
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li class="dropstart">
                                <a class="dropdown-item dropdown-toggle" href="#" data-bs-toggle="dropdown">Automatization</a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="/admin/gameroles">Gamer Roles</a></li>
                                    <li><a class="dropdown-item" href="/admin/autorooms">Auto rooms</a></li>
                                    <li><a class="dropdown-item" href="/admin/deleter">Auto Deleter</a></li>
                                    <li><a class="dropdown-item" href="/admin/reactionroles">Reaction Roles</a></li>
                                    <li><a class="dropdown-item" href="/admin/karma">Karma System</a></li>
                                    <li><a class="dropdown-item" href="/admin/giveaway">Giveaways</a></li>
                                    <li><a class="dropdown-item" href="/admin/polls">Polls</a></li>
                                    <li><a class="dropdown-item" href="/admin/reminders">Reminders</a></li>
                                    <li><a class="dropdown-item" href="/admin/enroll">Enrollment Wizard</a></li>
                                </ul>
                            </li>
                            <li class="dropstart">
                                <a class="dropdown-item dropdown-toggle" href="#" data-bs-toggle="dropdown">Information</a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="/admin/rss">RSS Feeds</a></li>
                                    <li><a class="dropdown-item" href="/admin/pokemon">Pokemon Go</a></li>
                                    <li><a class="dropdown-item" href="/admin/fonts">Fonts</a></li>
                                </ul>
                            </li>
                            <li class="dropstart">
                                <a class="dropdown-item dropdown-toggle" href="#" data-bs-toggle="dropdown">Server</a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="/admin/bot_config">Bot Configuration</a></li>
                                    <li><a class="dropdown-item" href="/admin/browse/data">Data Files</a></li>
                                    <li><a class="dropdown-item" href="/admin/backup">Backup System</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="confirmUpdate(); return false;">System Update</a></li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown">
                            Admin
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/admin">Admin Dashboard</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/logout">Logout</a></li>
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item"><a class="nav-link" href="/login">Login</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <main id="main-content" class="container mt-4" tabindex="-1">
        {% block content %}{% endblock %}
    </main>

    <div id="reconnecting-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; color: white; align-items: center; justify-content: center; flex-direction: column;">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 4rem; height: 4rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h2 class="mt-2">Reconnecting to Cthulhu...</h2>
        <p class="text-muted">The bot is restarting or offline.</p>
    </div>

    <!-- Image Management Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="imageModalLabel">Manage Image</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="modal-image-control"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
    const IS_ADMIN = {{ is_admin|tojson }};

    // Status Polling
    let wasOffline = false;
    setInterval(async () => {
        const overlay = document.getElementById('reconnecting-overlay');
        try {
            const response = await fetch('/api/status', { cache: "no-store" });
            if (response.ok) {
                const data = await response.json();
                if (data.status === 'online') {
                    if (wasOffline) {
                        location.reload(); // Reload page to refresh state
                    }
                    overlay.style.display = 'none';
                    wasOffline = false;
                } else {
                    overlay.style.display = 'flex';
                    wasOffline = true;
                }
            } else {
                overlay.style.display = 'flex';
                wasOffline = true;
            }
        } catch (e) {
            overlay.style.display = 'flex';
            wasOffline = true;
        }
    }, 3000);

    async function confirmUpdate() {
        if (confirm("Are you sure you want to update the bot? This will restart the system.")) {
            const checkbox = document.getElementById('updateInfodataCheck');
            const updateInfodata = checkbox ? checkbox.checked : false;

            try {
                const response = await fetch('/api/admin/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ update_infodata: updateInfodata })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    alert(data.message);
                    // Optionally disable UI or show loader
                } else {
                    alert('Update failed: ' + data.message);
                }
            } catch (error) {
                alert('Error connecting to server: ' + error);
            }
        }
    }

    // Fix for nested dropdowns on mobile (prevent closing parent)
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.dropdown-menu .dropdown-toggle').forEach(function(element) {
            element.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
            });
        });
    });

    // Image Management Helper
    async function initImageControl(containerId, typeSlug, name) {
        const container = document.getElementById(containerId);
        if (!container) return;

        if (!IS_ADMIN) {
             try {
                const response = await fetch(`/api/images/check?type_slug=${encodeURIComponent(typeSlug)}&name=${encodeURIComponent(name)}`);
                const data = await response.json();

                if (data.found) {
                     container.innerHTML = `
                        <div class="mb-3 text-center">
                            <img src="${data.url + '?t=' + new Date().getTime()}" class="img-fluid rounded" style="max-height: 200px;">
                        </div>
                     `;
                } else {
                     container.innerHTML = '';
                }
             } catch(e) {
                 console.error(e);
             }
             return;
        }

        container.innerHTML = `
            <div class="card bg-dark border-secondary">
                <div class="card-header border-secondary text-light">Image Management</div>
                <div class="card-body">
                    <div id="${containerId}-preview" class="mb-3 text-center" style="display:none;">
                        <img src="" class="img-fluid rounded" style="max-height: 200px;">
                        <div class="mt-2">
                            <button class="btn btn-sm btn-danger" onclick="deleteImage('${typeSlug}', '${name.replace(/'/g, "\\'")}', '${containerId}')">Delete Image</button>
                        </div>
                    </div>
                    <div id="${containerId}-upload">
                        <div class="input-group">
                            <input type="file" class="form-control bg-secondary text-light border-secondary" id="${containerId}-file" accept=".png,.jpg,.jpeg,.webp">
                            <button class="btn btn-success" type="button" onclick="uploadImage('${typeSlug}', '${name.replace(/'/g, "\\'")}', '${containerId}')">Upload</button>
                        </div>
                    </div>
                    <div id="${containerId}-status" class="mt-2 small"></div>
                </div>
            </div>
        `;

        checkImage(typeSlug, name, containerId);
    }

    async function checkImage(typeSlug, name, containerId) {
        try {
            const response = await fetch(`/api/images/check?type_slug=${encodeURIComponent(typeSlug)}&name=${encodeURIComponent(name)}`);
            const data = await response.json();

            const preview = document.getElementById(`${containerId}-preview`);
            const upload = document.getElementById(`${containerId}-upload`);
            const img = preview.querySelector('img');

            if (data.found) {
                img.src = data.url + '?t=' + new Date().getTime(); // Cache bust
                preview.style.display = 'block';
                upload.style.display = 'none';
            } else {
                preview.style.display = 'none';
                upload.style.display = 'block';
            }
        } catch (e) {
            console.error("Error checking image", e);
        }
    }

    async function uploadImage(typeSlug, name, containerId) {
        const fileInput = document.getElementById(`${containerId}-file`);
        const status = document.getElementById(`${containerId}-status`);

        if (fileInput.files.length === 0) {
            status.innerHTML = '<span class="text-danger">Please select a file.</span>';
            return;
        }

        const formData = new FormData();
        formData.append('type_slug', typeSlug);
        formData.append('name', name);
        formData.append('file', fileInput.files[0]);

        status.innerHTML = '<span class="text-info">Uploading...</span>';

        try {
            const response = await fetch('/api/images/upload', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.status === 'success') {
                status.innerHTML = '<span class="text-success">Uploaded successfully.</span>';
                checkImage(typeSlug, name, containerId); // Refresh
                fileInput.value = ''; // Clear input
            } else {
                status.innerHTML = `<span class="text-danger">Error: ${data.message}</span>`;
            }
        } catch (e) {
            status.innerHTML = `<span class="text-danger">Error: ${e.message}</span>`;
        }
    }

    async function deleteImage(typeSlug, name, containerId) {
        if (!confirm("Are you sure you want to delete this image?")) return;

        const status = document.getElementById(`${containerId}-status`);
        status.innerHTML = '<span class="text-info">Deleting...</span>';

        try {
            const response = await fetch('/api/images/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type_slug: typeSlug, name: name })
            });
            const data = await response.json();

            if (data.status === 'success') {
                status.innerHTML = '<span class="text-success">Deleted.</span>';
                checkImage(typeSlug, name, containerId); // Refresh
            } else {
                status.innerHTML = `<span class="text-danger">Error: ${data.message}</span>`;
            }
        } catch (e) {
            status.innerHTML = `<span class="text-danger">Error: ${e.message}</span>`;
        }
    }

    function openImageModal(typeSlug, name) {
        const modalEl = document.getElementById('imageModal');
        const modal = new bootstrap.Modal(modalEl);
        document.getElementById('imageModalLabel').textContent = `Manage Image: ${name}`;
        // Clear previous content status to avoid confusion
        const containerId = 'modal-image-control';
        document.getElementById(containerId).innerHTML = '';

        modal.show();
        // Wait for modal to show slightly or just run
        initImageControl(containerId, typeSlug, name);
    }
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
