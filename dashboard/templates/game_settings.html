{% extends 'base.html' %}

{% block title %}Game Settings{% endblock %}

{% block content %}
<h2 class="mb-4">Game Settings</h2>

<div class="card">
    <div class="card-header">
        Luck Threshold Settings
    </div>
    <div class="card-body">
        <p class="card-text">Set the maximum amount of Luck a player can spend on a single roll. (Default: 10)</p>
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="settingsTable">
                <thead>
                    <tr>
                        <th>Server Name</th>
                        <th>Server ID</th>
                        <th>Luck Threshold</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="settingsBody">
                    <tr><td colspan="4">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', loadSettings);

async function loadSettings() {
    try {
        const response = await fetch('/api/game/settings/data');
        const data = await response.json();
        const tbody = document.getElementById('settingsBody');
        tbody.innerHTML = '';

        if (!data.guilds || data.guilds.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4">No servers found.</td></tr>';
            return;
        }

        data.guilds.forEach(guild => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${guild.name}</td>
                <td>${guild.id}</td>
                <td>
                    <input type="number" class="form-control" id="luck-${guild.id}" value="${guild.luck_threshold}" min="0" style="max-width: 100px;">
                </td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="saveLuck('${guild.id}')">Save</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

    } catch (error) {
        console.error('Error loading settings:', error);
        document.getElementById('settingsBody').innerHTML = '<tr><td colspan="4" class="text-danger">Error loading data.</td></tr>';
    }
}

async function saveLuck(guildId) {
    const input = document.getElementById(`luck-${guildId}`);
    const newValue = input.value;

    if (newValue === "" || parseInt(newValue) < 0) {
        alert("Please enter a valid non-negative number.");
        return;
    }

    try {
        const response = await fetch('/api/game/luck/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                guild_id: guildId,
                luck_value: parseInt(newValue)
            })
        });

        const data = await response.json();

        if (data.status === 'success') {
            // Optional: Show a toast or small indicator
            const btn = input.parentElement.nextElementSibling.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "Saved!";
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-success');
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-primary');
            }, 2000);
        } else {
            alert("Error: " + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert("An error occurred while saving.");
    }
}
</script>
{% endblock %}
