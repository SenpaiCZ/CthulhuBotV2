{% extends 'base.html' %}

{% block title %}Auto Deleter{% endblock %}

{% block content %}
<h2 class="mb-4">Auto Deleter</h2>
<p class="text-muted">Manage auto-deletion rules and bulk delete messages.</p>

<div class="row mb-4">
    <!-- Add Rule -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <strong>Add / Update Auto-Deleter Rule</strong>
            </div>
            <div class="card-body">
                <form id="add-rule-form">
                    <div class="mb-3">
                        <label for="guild-select" class="form-label">Server</label>
                        <select class="form-select" id="guild-select" required>
                            <option value="" selected disabled>Select Server...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="channel-select" class="form-label">Channel</label>
                        <select class="form-select" id="channel-select" required disabled>
                            <option value="" selected disabled>Select Channel...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="time-select" class="form-label">Time Limit (Message Age)</label>
                        <select class="form-select" id="time-select" required>
                            <option value="600">10 Minutes</option>
                            <option value="1800">30 Minutes</option>
                            <option value="3600">1 Hour</option>
                            <option value="21600">6 Hours</option>
                            <option value="43200">12 Hours</option>
                            <option value="86400" selected>1 Day</option>
                            <option value="259200">3 Days</option>
                            <option value="604800">1 Week</option>
                            <option value="1209600">2 Weeks</option>
                            <option value="2592000">1 Month</option>
                            <option value="custom">Custom (Seconds)</option>
                        </select>
                    </div>
                    <div class="mb-3 d-none" id="custom-time-div">
                        <label for="custom-seconds" class="form-label">Custom Seconds</label>
                        <input type="number" class="form-control" id="custom-seconds" placeholder="e.g. 3600" min="60">
                    </div>

                    <button type="submit" class="btn btn-success w-100" id="save-btn">
                        <span id="save-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Save Rule
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Bulk Delete -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <strong>Manual Bulk Delete</strong>
            </div>
            <div class="card-body">
                <p class="small text-muted">Delete the last X messages from a channel immediately.</p>
                <form id="bulk-delete-form">
                    <div class="mb-3">
                        <label for="bulk-guild-select" class="form-label">Server</label>
                        <select class="form-select" id="bulk-guild-select" required>
                            <option value="" selected disabled>Select Server...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="bulk-channel-select" class="form-label">Channel</label>
                        <select class="form-select" id="bulk-channel-select" required disabled>
                            <option value="" selected disabled>Select Channel...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="bulk-amount" class="form-label">Amount of Messages</label>
                        <input type="number" class="form-control" id="bulk-amount" min="1" max="1000" value="10" required>
                    </div>

                    <button type="submit" class="btn btn-danger w-100" id="bulk-btn">
                        <span id="bulk-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Bulk Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <strong>Active Rules</strong>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle" id="rules-table">
                <thead>
                    <tr>
                        <th>Server</th>
                        <th>Channel</th>
                        <th>Time Limit</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Populated via JS -->
                </tbody>
            </table>
        </div>
        <div id="loading-spinner" class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="no-data-message" class="text-center py-3 d-none">
            <p class="text-muted">No auto-deleter rules configured.</p>
        </div>
    </div>
</div>

<script>
let globalData = null;

document.addEventListener('DOMContentLoaded', () => {
    fetchData();

    // Add Rule Form
    document.getElementById('guild-select').addEventListener('change', (e) => {
        updateChannelSelect(e.target.value, 'channel-select');
    });

    document.getElementById('time-select').addEventListener('change', (e) => {
        const customDiv = document.getElementById('custom-time-div');
        if (e.target.value === 'custom') {
            customDiv.classList.remove('d-none');
        } else {
            customDiv.classList.add('d-none');
        }
    });

    document.getElementById('add-rule-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveRule();
    });

    // Bulk Delete Form
    document.getElementById('bulk-guild-select').addEventListener('change', (e) => {
        updateChannelSelect(e.target.value, 'bulk-channel-select');
    });

    document.getElementById('bulk-delete-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await bulkDelete();
    });
});

async function fetchData() {
    try {
        const response = await fetch('/api/deleter/data');
        const data = await response.json();
        globalData = data;

        populateGuildSelects(data.guilds);
        renderRulesTable(data.guilds);

        document.getElementById('loading-spinner').classList.add('d-none');
    } catch (error) {
        console.error("Error loading data:", error);
        alert("Failed to load data.");
    }
}

function populateGuildSelects(guilds) {
    const selects = ['guild-select', 'bulk-guild-select'];

    selects.forEach(id => {
        const select = document.getElementById(id);
        const currentVal = select.value;
        select.innerHTML = '<option value="" selected disabled>Select Server...</option>';

        guilds.forEach(guild => {
            const option = document.createElement('option');
            option.value = guild.id;
            option.textContent = guild.name;
            select.appendChild(option);
        });

        if (currentVal) select.value = currentVal;
    });
}

function updateChannelSelect(guildId, targetId) {
    const channelSelect = document.getElementById(targetId);
    channelSelect.innerHTML = '<option value="" selected disabled>Select Channel...</option>';
    channelSelect.disabled = true;

    if (!guildId || !globalData) return;

    const guild = globalData.guilds.find(g => g.id === guildId);
    if (guild && guild.channels) {
        guild.channels.forEach(channel => {
            const option = document.createElement('option');
            option.value = channel.id;
            option.textContent = channel.name;
            channelSelect.appendChild(option);
        });
        channelSelect.disabled = false;
    }
}

function renderRulesTable(guilds) {
    const tbody = document.querySelector('#rules-table tbody');
    tbody.innerHTML = '';
    let hasRules = false;

    guilds.forEach(guild => {
        if (guild.channels) {
            guild.channels.forEach(channel => {
                if (channel.is_active) {
                    hasRules = true;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${guild.name}</td>
                        <td>${channel.name} <br> <small class="text-muted">${channel.id}</small></td>
                        <td>${formatSeconds(channel.seconds)}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteRule('${channel.id}')">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
            });
        }
    });

    const noDataMsg = document.getElementById('no-data-message');
    if (!hasRules) {
        noDataMsg.classList.remove('d-none');
    } else {
        noDataMsg.classList.add('d-none');
    }
}

function formatSeconds(seconds) {
    if (seconds < 60) return seconds + "s";
    if (seconds < 3600) return Math.floor(seconds / 60) + "m";
    if (seconds < 86400) return Math.floor(seconds / 3600) + "h";
    return Math.floor(seconds / 86400) + "d";
}

async function saveRule() {
    const guildId = document.getElementById('guild-select').value;
    const channelId = document.getElementById('channel-select').value;
    let seconds = document.getElementById('time-select').value;

    if (seconds === 'custom') {
        seconds = document.getElementById('custom-seconds').value;
    }

    if (!guildId || !channelId || !seconds) {
        alert("Please fill in all fields.");
        return;
    }

    const btn = document.getElementById('save-btn');
    const spinner = document.getElementById('save-spinner');
    btn.disabled = true;
    spinner.classList.remove('d-none');

    try {
        const response = await fetch('/api/deleter/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                channel_id: channelId,
                seconds: seconds
            })
        });

        const res = await response.json();
        if (res.status === 'success') {
            await fetchData();
            alert("Rule saved successfully!");
        } else {
            alert("Error: " + res.message);
        }
    } catch (e) {
        console.error(e);
        alert("Failed to save rule.");
    } finally {
        btn.disabled = false;
        spinner.classList.add('d-none');
    }
}

async function deleteRule(channelId) {
    if (!confirm("Are you sure you want to disable auto-deleter for this channel?")) return;

    try {
        const response = await fetch('/api/deleter/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                channel_id: channelId
            })
        });

        const res = await response.json();
        if (res.status === 'success') {
            await fetchData();
        } else {
            alert("Error: " + res.message);
        }
    } catch (e) {
        console.error(e);
        alert("Failed to delete rule.");
    }
}

async function bulkDelete() {
    const guildId = document.getElementById('bulk-guild-select').value;
    const channelId = document.getElementById('bulk-channel-select').value;
    const amount = document.getElementById('bulk-amount').value;

    if (!guildId || !channelId || !amount) {
        alert("Please fill in all fields.");
        return;
    }

    if (!confirm(`Are you sure you want to delete the last ${amount} messages in this channel? This cannot be undone.`)) return;

    const btn = document.getElementById('bulk-btn');
    const spinner = document.getElementById('bulk-spinner');
    btn.disabled = true;
    spinner.classList.remove('d-none');

    try {
        const response = await fetch('/api/deleter/bulk_delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                channel_id: channelId,
                amount: amount
            })
        });

        const res = await response.json();
        if (res.status === 'success') {
            alert(`Successfully deleted ${res.count} messages.`);
        } else {
            alert("Error: " + res.message);
        }
    } catch (e) {
        console.error(e);
        alert("Failed to bulk delete.");
    } finally {
        btn.disabled = false;
        spinner.classList.add('d-none');
    }
}
</script>
{% endblock %}
