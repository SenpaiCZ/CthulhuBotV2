{% extends 'base.html' %}

{% block title %}RSS Feeds{% endblock %}

{% block content %}
<h2 class="mb-4">RSS Feeds</h2>
<p class="text-muted">Manage RSS feed subscriptions for your servers.</p>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <strong>Add New RSS Feed</strong>
            </div>
            <div class="card-body">
                <form id="add-rss-form" class="row g-3">
                    <div class="col-md-3">
                        <label for="guild-select" class="form-label">Server</label>
                        <select class="form-select" id="guild-select" required>
                            <option value="" selected disabled>Select Server...</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="rss-link" class="form-label">RSS Link</label>
                        <input type="url" class="form-control" id="rss-link" placeholder="https://example.com/feed.xml" required>
                    </div>
                    <div class="col-md-2">
                        <label for="rss-color" class="form-label">Color</label>
                        <input type="color" class="form-control form-control-color w-100" id="rss-color" value="#2E8B57" title="Choose your color">
                    </div>
                    <div class="col-md-2">
                        <label for="channel-select" class="form-label">Channel</label>
                        <select class="form-select" id="channel-select" required disabled>
                            <option value="" selected disabled>Select Channel...</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-success w-100" id="add-btn">
                            <span id="add-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            Add
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <strong>Active RSS Feeds</strong>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle" id="rss-feeds-table">
                <thead>
                    <tr>
                        <th>Server</th>
                        <th>Channel</th>
                        <th>RSS Link</th>
                        <th>Color</th>
                        <th>Last Post</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Populated via JS -->
                </tbody>
            </table>
        </div>
        <div id="rss-loading-spinner" class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="rss-no-data-message" class="text-center py-3 d-none">
            <p class="text-muted">No RSS feeds configured.</p>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <strong>YouTube Subscriptions</strong>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle" id="youtube-feeds-table">
                <thead>
                    <tr>
                        <th>Server</th>
                        <th>Channel</th>
                        <th>RSS Link</th>
                        <th>Color</th>
                        <th>Last Post</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Populated via JS -->
                </tbody>
            </table>
        </div>
        <div id="youtube-loading-spinner" class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="youtube-no-data-message" class="text-center py-3 d-none">
            <p class="text-muted">No YouTube subscriptions configured.</p>
        </div>
    </div>
</div>

<script>
let globalData = null;

document.addEventListener('DOMContentLoaded', () => {
    fetchData();

    document.getElementById('guild-select').addEventListener('change', (e) => {
        updateChannelSelect(e.target.value);
    });

    document.getElementById('add-rss-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await addFeed();
    });
});

async function fetchData() {
    try {
        const response = await fetch('/api/rss/data');
        const data = await response.json();
        globalData = data;

        populateGuildSelect(data.guilds);

        const rssFeeds = data.feeds.filter(f => !f.link.includes('youtube.com'));
        const youtubeFeeds = data.feeds.filter(f => f.link.includes('youtube.com'));

        renderFeedTable(rssFeeds, 'rss-feeds-table', 'rss-no-data-message');
        renderFeedTable(youtubeFeeds, 'youtube-feeds-table', 'youtube-no-data-message');

        document.getElementById('rss-loading-spinner').classList.add('d-none');
        document.getElementById('youtube-loading-spinner').classList.add('d-none');
    } catch (error) {
        console.error("Error loading data:", error);
        alert("Failed to load RSS data.");
    }
}

function populateGuildSelect(guilds) {
    const select = document.getElementById('guild-select');
    const currentVal = select.value;

    select.innerHTML = '<option value="" selected disabled>Select Server...</option>';

    guilds.forEach(guild => {
        const option = document.createElement('option');
        option.value = guild.id;
        option.textContent = guild.name;
        select.appendChild(option);
    });

    if (currentVal) {
        select.value = currentVal;
    }
}

function updateChannelSelect(guildId) {
    const channelSelect = document.getElementById('channel-select');
    channelSelect.innerHTML = '<option value="" selected disabled>Select Channel...</option>';
    channelSelect.disabled = true;

    if (!guildId || !globalData) return;

    const guild = globalData.guilds.find(g => g.id === guildId);
    if (guild && guild.channels) {
        guild.channels.forEach(channel => {
            const option = document.createElement('option');
            option.value = channel.id;
            option.textContent = channel.name;
            channelSelect.appendChild(option);
        });
        channelSelect.disabled = false;
    }
}

function renderFeedTable(feeds, tableId, noDataMsgId) {
    const tbody = document.querySelector(`#${tableId} tbody`);
    tbody.innerHTML = '';
    const noDataMsg = document.getElementById(noDataMsgId);

    if (feeds.length === 0) {
        noDataMsg.classList.remove('d-none');
        return;
    } else {
        noDataMsg.classList.add('d-none');
    }

    feeds.forEach(feed => {
        const tr = document.createElement('tr');

        // Truncate long URLs
        const displayLink = feed.link.length > 50 ? feed.link.substring(0, 47) + '...' : feed.link;

        tr.innerHTML = `
            <td>${feed.guild_name} <br> <small class="text-muted">${feed.guild_id}</small></td>
            <td>${feed.channel_name} <br> <small class="text-muted">${feed.channel_id}</small></td>
            <td><a href="${feed.link}" target="_blank" title="${feed.link}">${displayLink}</a></td>
            <td>
                <input type="color" class="form-control form-control-color" value="${feed.color || '#2E8B57'}"
                       onchange="updateColor('${feed.guild_id}', '${feed.link}', this.value)" title="Update Color">
            </td>
            <td><small>${feed.last_message || 'None'}</small></td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="deleteFeed('${feed.guild_id}', '${feed.link}')">
                    Delete
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

async function addFeed() {
    const guildId = document.getElementById('guild-select').value;
    const link = document.getElementById('rss-link').value.trim();
    const channelId = document.getElementById('channel-select').value;
    const color = document.getElementById('rss-color').value;
    const btn = document.getElementById('add-btn');
    const spinner = document.getElementById('add-spinner');

    if (!guildId || !link || !channelId) {
        alert("Please fill in all fields.");
        return;
    }

    // Loading state
    btn.disabled = true;
    spinner.classList.remove('d-none');

    try {
        const response = await fetch('/api/rss/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                guild_id: guildId,
                link: link,
                channel_id: channelId,
                color: color
            })
        });

        const res = await response.json();
        if (res.status === 'success') {
            await fetchData();
            document.getElementById('rss-link').value = '';
            // document.getElementById('channel-select').value = ''; // Keep selection for rapid add
            alert("Feed added successfully!");
        } else {
            alert("Error: " + res.message);
        }
    } catch (e) {
        console.error(e);
        alert("Failed to add feed.");
    } finally {
        btn.disabled = false;
        spinner.classList.add('d-none');
    }
}

async function updateColor(guildId, link, newColor) {
    try {
        const response = await fetch('/api/rss/update_color', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                guild_id: guildId,
                link: link,
                color: newColor
            })
        });

        const res = await response.json();
        if (res.status !== 'success') {
             alert("Error updating color: " + res.message);
        }
    } catch (e) {
        console.error(e);
        alert("Failed to update color.");
    }
}

async function deleteFeed(guildId, link) {
    if (!confirm("Are you sure you want to delete this feed?")) return;

    try {
        const response = await fetch('/api/rss/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                guild_id: guildId,
                link: link
            })
        });

        const res = await response.json();
        if (res.status === 'success') {
            await fetchData();
        } else {
            alert("Error: " + res.message);
        }
    } catch (e) {
        console.error(e);
        alert("Failed to delete feed.");
    }
}
</script>
{% endblock %}
