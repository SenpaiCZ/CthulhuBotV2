{% extends 'base.html' %}

{% block title %}Monsters - CoC Bot{% endblock %}

{% block content %}
<div class="container-fluid dashboard-container">
    <div class="sidebar-panel">
        <div class="card-header bg-dark text-white p-2 text-center border border-secondary border-bottom-0 rounded-top">
            <h5 class="m-0 text-success">Grimoire</h5>
        </div>
        <div class="p-2 border border-secondary border-bottom-0 border-top-0 bg-dark">
            <input type="text" id="searchInput" class="form-control form-control-sm bg-secondary text-light border-secondary" placeholder="Search...">
        </div>
        <div class="list-group list-group-flush sidebar-list" id="monsterList">
            {% if data and data.monsters %}
                {% for item in data.monsters %}
                    {% set m = item.monster_entry %}
                    <button type="button" class="list-group-item list-group-item-action monster-list-item" onclick="showMonster({{ loop.index0 }})">
                        {{ m.name }}
                    </button>
                {% endfor %}
            {% else %}
                <div class="p-3 text-center text-muted">No monsters found.</div>
            {% endif %}
        </div>
    </div>

    <div class="detail-panel" id="detailPanel">
        <div id="monster-placeholder" class="text-center d-flex flex-column justify-content-center h-100">
            <h2 class="text-muted" style="opacity: 0.3;">Select a creature</h2>
            <p class="text-secondary">View detailed statistics from the archives.</p>
        </div>

        <div id="monster-content" class="hidden">
            <!-- Template content populated by JS -->
        </div>
    </div>
</div>

<script>
    // Search Functionality
    document.getElementById('searchInput').addEventListener('input', function() {
        const filter = this.value.toLowerCase();
        const items = document.querySelectorAll('.monster-list-item');
        items.forEach(item => {
            const text = item.textContent.toLowerCase();
            if(text.includes(filter)) {
                item.classList.remove('hidden');
            } else {
                item.classList.add('hidden');
            }
        });
    });

    // Pass Python data to JS safely
    const monsters = {{ data.monsters | tojson }};

    function showMonster(index) {
        try {
            const m = monsters[index].monster_entry;
            const container = document.getElementById('monster-content');
            const placeholder = document.getElementById('monster-placeholder');

            // Highlight active item
            document.querySelectorAll('.monster-list-item').forEach((el, i) => {
                if(i === index) el.classList.add('active');
                else el.classList.remove('active');
            });

            let html = `
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h1 class="display-5 mb-0 text-success">${m.name}</h1>
                        <div class="text-secondary fst-italic fs-5">${m.subtitle || ''}</div>
                    </div>
                    <div class="text-end">
                         ${(m.tags || []).map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('')}
                    </div>
                </div>

                <div class="card bg-dark border-secondary mb-4">
                    <div class="card-body">
                        ${m.description ? `<p class="card-text border-start border-success border-3 ps-3">${m.description}</p>` : ''}
                        ${m.main_entry_text ? `<p class="card-text text-muted small">${m.main_entry_text}</p>` : ''}
                    </div>
                </div>

                <div class="section-header">Characteristics</div>
                <div class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-2 mb-4">
                    ${Object.entries(m.characteristics || {}).map(([key, val]) => `
                        <div class="col">
                            <div class="stat-box h-100">
                                <div class="stat-label">${key}</div>
                                <div class="stat-value text-light">${val.average || val}</div>
                                <div class="small text-muted">${val.roll || ''}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="section-header">Derived Stats</div>
                <div class="row row-cols-2 row-cols-md-5 g-2 mb-4">
                    <div class="col"><div class="stat-box"><div class="stat-label">HP</div><div class="stat-value text-danger">${m.derived_stats.hit_points}</div></div></div>
                    <div class="col"><div class="stat-box"><div class="stat-label">DB</div><div class="stat-value">${m.derived_stats.damage_bonus}</div></div></div>
                    <div class="col"><div class="stat-box"><div class="stat-label">Build</div><div class="stat-value">${m.derived_stats.build}</div></div></div>
                    <div class="col"><div class="stat-box"><div class="stat-label">MP</div><div class="stat-value text-info">${m.derived_stats.magic_points}</div></div></div>
                    <div class="col">
                        <div class="stat-box">
                            <div class="stat-label">Move</div>
                            <div class="stat-value">
                                ${typeof m.derived_stats.move === 'object' ?
                                    `${m.derived_stats.move.base} ${m.derived_stats.move.special ? `<span class="small text-muted">(${m.derived_stats.move.special})</span>` : ''}` :
                                    m.derived_stats.move}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-6">
                        <div class="section-header">Combat</div>
                        <p class="mb-2"><span class="text-success fw-bold">Attacks per round:</span> ${m.combat.attacks_per_round}</p>

                        <div class="list-group mb-3">
                            ${(m.combat.attacks || []).map(atk => `
                                <div class="list-group-item list-group-item-action bg-dark border-secondary">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1 text-light">${atk.name}</h6>
                                        <span class="badge bg-danger rounded-pill">${atk.success_chance || 'Auto'}</span>
                                    </div>
                                    <p class="mb-1 text-danger fw-bold">Damage: ${atk.damage}</p>
                                    ${atk.special_effect ? `<small class="text-info d-block">Effect: ${atk.special_effect}</small>` : ''}
                                    ${atk.description ? `<small class="text-muted d-block">${atk.description}</small>` : ''}
                                </div>
                            `).join('')}
                        </div>
                        <p><span class="text-success fw-bold">Dodge:</span> ${m.combat.dodge ? (m.combat.dodge.success_chance || 'N/A') : 'N/A'}</p>
                    </div>

                    <div class="col-lg-6">
                        <div class="section-header">Skills & Abilities</div>
                        ${m.skills ? `
                            <div class="mb-3">
                                <h6 class="text-muted small text-uppercase">Skills</h6>
                                <div class="d-flex flex-wrap gap-2">
                                ${m.skills.map(s => `<span class="badge bg-secondary border border-secondary">${s.name} <span class="text-warning ms-1">${s.value}</span></span>`).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${m.powers_and_abilities ? `
                            <div class="mt-4">
                                <h6 class="text-muted small text-uppercase">Powers</h6>
                                <ul class="list-group list-group-flush bg-transparent">
                                ${m.powers_and_abilities.map(p => `
                                    <li class="list-group-item bg-transparent border-secondary ps-0">
                                        <strong class="text-warning">${p.name}:</strong> <span class="text-secondary">${p.description}</span>
                                    </li>
                                `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <div class="section-header">Defenses & Magic</div>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="card bg-dark border-secondary h-100">
                            <div class="card-header bg-secondary bg-opacity-10 border-secondary text-success py-1 small fw-bold">ARMOR</div>
                            <div class="card-body">
                                ${m.armor ? (m.armor.rating + (m.armor.modifiers ? `<br><small class="text-muted">${m.armor.modifiers}</small>` : '')) : 'None'}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-dark border-secondary h-100">
                            <div class="card-header bg-secondary bg-opacity-10 border-secondary text-success py-1 small fw-bold">SPELLS</div>
                            <div class="card-body small">
                                ${m.spells || 'None'}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-dark border-secondary h-100">
                            <div class="card-header bg-secondary bg-opacity-10 border-secondary text-success py-1 small fw-bold">SANITY LOSS</div>
                            <div class="card-body text-danger">
                                ${m.sanity_loss || 'None'}
                            </div>
                        </div>
                    </div>
                </div>

                ${m.alternative_names ? `
                    <div class="mt-5 pt-3 border-top border-secondary small text-muted text-center">
                        <em>Also known as: ${m.alternative_names.join(', ')}</em>
                    </div>
                ` : ''}
            `;

            container.innerHTML = html;
            container.classList.remove('hidden');
            placeholder.style.setProperty('display', 'none', 'important');
            placeholder.classList.remove('d-flex');

            document.getElementById('detailPanel').scrollTop = 0;
        } catch (e) {
            console.error(e);
            alert("Error rendering monster: " + e.message);
        }
    }
</script>
{% endblock %}
