{% extends 'base.html' %}

{% block title %}Reaction Roles{% endblock %}

{% block content %}
<h2 class="mb-4">Reaction Roles</h2>
<p class="text-muted">Configure roles to be assigned when users react with specific emojis.</p>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <strong>Add New Reaction Role</strong>
            </div>
            <div class="card-body">
                <form id="add-rr-form" class="row g-3">
                    <div class="col-md-2">
                        <label for="guild-select" class="form-label">Server</label>
                        <select class="form-select" id="guild-select" required>
                            <option value="" selected disabled>Select Server...</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="channel-select" class="form-label">Channel</label>
                        <select class="form-select" id="channel-select" required disabled>
                            <option value="" selected disabled>Select Channel...</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="message-id" class="form-label">Message ID</label>
                        <input type="text" class="form-control" id="message-id" placeholder="123456789..." required>
                    </div>
                    <div class="col-md-2">
                        <label for="role-select" class="form-label">Role</label>
                        <select class="form-select" id="role-select" required disabled>
                            <option value="" selected disabled>Select Role...</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="emoji-input" class="form-label">Emoji</label>
                        <input type="text" class="form-control" id="emoji-input" placeholder="ðŸ‘" required>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-success w-100">Add</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <strong>Active Rules</strong>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle" id="rules-table">
                <thead>
                    <tr>
                        <th>Server</th>
                        <th>Message ID</th>
                        <th>Emoji</th>
                        <th>Role</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Populated via JS -->
                </tbody>
            </table>
        </div>
        <div id="loading-spinner" class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="no-data-message" class="text-center py-3 d-none">
            <p class="text-muted">No reaction roles configured.</p>
        </div>
    </div>
</div>

<script>
let globalData = null;

document.addEventListener('DOMContentLoaded', () => {
    fetchData();

    document.getElementById('guild-select').addEventListener('change', (e) => {
        updateRoleSelect(e.target.value);
        updateChannelSelect(e.target.value);
    });

    document.getElementById('add-rr-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await addRule();
    });
});

async function fetchData() {
    try {
        const response = await fetch('/api/reactionroles/data');
        const data = await response.json();
        globalData = data;

        populateGuildSelect(data.guilds);
        renderTable(data.rules);

        document.getElementById('loading-spinner').classList.add('d-none');
    } catch (error) {
        console.error("Error loading data:", error);
        alert("Failed to load reaction roles data.");
    }
}

function populateGuildSelect(guilds) {
    const select = document.getElementById('guild-select');
    // Save current selection if any
    const currentVal = select.value;

    select.innerHTML = '<option value="" selected disabled>Select Server...</option>';

    guilds.forEach(guild => {
        const option = document.createElement('option');
        option.value = guild.id;
        option.textContent = guild.name;
        select.appendChild(option);
    });

    if (currentVal) {
        select.value = currentVal;
    }
}

function updateRoleSelect(guildId) {
    const roleSelect = document.getElementById('role-select');
    roleSelect.innerHTML = '<option value="" selected disabled>Select Role...</option>';
    roleSelect.disabled = true;

    if (!guildId || !globalData) return;

    const guild = globalData.guilds.find(g => g.id === guildId);
    if (guild && guild.roles) {
        guild.roles.forEach(role => {
            const option = document.createElement('option');
            option.value = role.id;
            option.textContent = role.name;
            roleSelect.appendChild(option);
        });
        roleSelect.disabled = false;
    }
}

function updateChannelSelect(guildId) {
    const channelSelect = document.getElementById('channel-select');
    channelSelect.innerHTML = '<option value="" selected disabled>Select Channel...</option>';
    channelSelect.disabled = true;

    if (!guildId || !globalData) return;

    const guild = globalData.guilds.find(g => g.id === guildId);
    if (guild && guild.channels) {
        guild.channels.forEach(channel => {
            const option = document.createElement('option');
            option.value = channel.id;
            option.textContent = channel.name;
            channelSelect.appendChild(option);
        });
        channelSelect.disabled = false;
    }
}

function renderTable(rules) {
    const tbody = document.querySelector('#rules-table tbody');
    tbody.innerHTML = '';

    if (rules.length === 0) {
        document.getElementById('no-data-message').classList.remove('d-none');
        return;
    } else {
        document.getElementById('no-data-message').classList.add('d-none');
    }

    rules.forEach(rule => {
        const tr = document.createElement('tr');

        // Parse emoji for display
        let emojiDisplay = rule.emoji;
        // Regex for custom emojis: <:name:id> or <a:name:id>
        const customEmojiMatch = rule.emoji.match(/^<a?:.*:(\d+)>$/);

        if (customEmojiMatch) {
            const emojiId = customEmojiMatch[1];
            const isAnimated = rule.emoji.startsWith('<a:');
            const ext = isAnimated ? 'gif' : 'png';
            emojiDisplay = `<img src="https://cdn.discordapp.com/emojis/${emojiId}.${ext}" alt="${rule.emoji}" title="${rule.emoji}" style="width: 32px; height: 32px; object-fit: contain;">`;
        }

        tr.innerHTML = `
            <td>${rule.guild_name} <br> <small class="text-muted">${rule.guild_id}</small></td>
            <td>${rule.message_id}</td>
            <td>${emojiDisplay}</td>
            <td>${rule.role_name} <br> <small class="text-muted">${rule.role_id}</small></td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="deleteRule('${rule.guild_id}', '${rule.message_id}', '${rule.emoji}')">
                    Delete
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

async function addRule() {
    const guildId = document.getElementById('guild-select').value;
    const channelId = document.getElementById('channel-select').value;
    const messageId = document.getElementById('message-id').value.trim();
    const roleId = document.getElementById('role-select').value;
    const emoji = document.getElementById('emoji-input').value.trim();

    if (!guildId || !channelId || !messageId || !roleId || !emoji) {
        alert("Please fill in all fields.");
        return;
    }

    try {
        const response = await fetch('/api/reactionroles/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                guild_id: guildId,
                channel_id: channelId,
                message_id: messageId,
                role_id: roleId,
                emoji: emoji
            })
        });

        const res = await response.json();
        if (res.status === 'success') {
            // Refresh data
            await fetchData();
            // Clear inputs except guild? Or clear all?
            document.getElementById('message-id').value = '';
            document.getElementById('emoji-input').value = '';
            // keep guild and role select as is for rapid adding
        } else {
            alert("Error: " + res.message);
        }
    } catch (e) {
        console.error(e);
        alert("Failed to add rule.");
    }
}

async function deleteRule(guildId, messageId, emoji) {
    if (!confirm("Are you sure you want to delete this reaction role?")) return;

    try {
        const response = await fetch('/api/reactionroles/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                guild_id: guildId,
                message_id: messageId,
                emoji: emoji
            })
        });

        const res = await response.json();
        if (res.status === 'success') {
            await fetchData();
        } else {
            alert("Error: " + res.message);
        }
    } catch (e) {
        console.error(e);
        alert("Failed to delete rule.");
    }
}
</script>
{% endblock %}
