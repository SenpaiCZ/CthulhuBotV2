{% extends 'base.html' %}

{% block title %}Reminders Manager{% endblock %}

{% block content %}
<h2 class="mb-4">Reminders Manager</h2>
<p class="text-muted">View and manage active reminders.</p>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <strong>Set New Reminder</strong>
            </div>
            <div class="card-body">
                <form id="create-reminder-form" class="row g-3">
                    <div class="col-md-3">
                        <label for="guild-select" class="form-label">Server</label>
                        <select class="form-select" id="guild-select" required>
                            <option value="" selected disabled>Select Server...</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="channel-select" class="form-label">Channel</label>
                        <select class="form-select" id="channel-select" required disabled>
                            <option value="" selected disabled>Select Channel...</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="user-select" class="form-label">User</label>
                        <select class="form-select" id="user-select" required disabled>
                            <option value="" selected disabled>Select User...</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="duration-input" class="form-label">Duration</label>
                        <input type="text" class="form-control" id="duration-input" placeholder="e.g. 2h, 30m, 1d" required>
                    </div>
                    <div class="col-md-12">
                        <label for="message-input" class="form-label">Message</label>
                        <input type="text" class="form-control" id="message-input" placeholder="What to remind about?" required>
                    </div>
                    <div class="col-12 text-end">
                        <button type="submit" class="btn btn-warning">Set Reminder</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <strong>Active Reminders</strong>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle" id="reminders-table">
                <thead>
                    <tr>
                        <th>Server</th>
                        <th>User</th>
                        <th>Message</th>
                        <th>Channel</th>
                        <th>Due Time</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="reminders-body">
                    <!-- Populated via JS -->
                </tbody>
            </table>
        </div>
        <div id="loading-spinner" class="text-center py-3">
            <div class="spinner-border text-warning" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="no-data-message" class="text-center py-3 d-none">
            <p class="text-muted">No active reminders found.</p>
        </div>
    </div>
</div>

<script>
let globalData = null;

document.addEventListener('DOMContentLoaded', () => {
    fetchData();

    document.getElementById('guild-select').addEventListener('change', (e) => {
        updateChannelSelect(e.target.value);
        updateUserSelect(e.target.value);
    });

    document.getElementById('create-reminder-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await createReminder();
    });
});

async function fetchData() {
    try {
        const response = await fetch('/api/reminders/data');
        const data = await response.json();
        globalData = data;

        populateGuildSelect(data.guilds);
        renderTable(data.guilds);

        document.getElementById('loading-spinner').classList.add('d-none');
    } catch (error) {
        console.error("Error loading data:", error);
        alert("Failed to load reminders data.");
    }
}

function populateGuildSelect(guilds) {
    const select = document.getElementById('guild-select');
    const currentVal = select.value;

    select.innerHTML = '<option value="" selected disabled>Select Server...</option>';

    guilds.forEach(guild => {
        const option = document.createElement('option');
        option.value = guild.id;
        option.textContent = guild.name;
        select.appendChild(option);
    });

    if (currentVal) {
        select.value = currentVal;
    }
}

function updateChannelSelect(guildId) {
    const channelSelect = document.getElementById('channel-select');
    channelSelect.innerHTML = '<option value="" selected disabled>Select Channel...</option>';
    channelSelect.disabled = true;

    if (!guildId || !globalData) return;

    const guild = globalData.guilds.find(g => g.id === guildId);
    if (guild && guild.channels) {
        guild.channels.forEach(channel => {
            const option = document.createElement('option');
            option.value = channel.id;
            option.textContent = channel.name;
            channelSelect.appendChild(option);
        });
        channelSelect.disabled = false;
    }
}

function updateUserSelect(guildId) {
    const userSelect = document.getElementById('user-select');
    userSelect.innerHTML = '<option value="" selected disabled>Select User...</option>';
    userSelect.disabled = true;

    if (!guildId || !globalData) return;

    const guild = globalData.guilds.find(g => g.id === guildId);
    if (guild && guild.users) {
        guild.users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = user.name;
            userSelect.appendChild(option);
        });
        userSelect.disabled = false;
    }
}

function renderTable(guilds) {
    const tbody = document.getElementById('reminders-body');
    tbody.innerHTML = '';
    let hasReminders = false;

    guilds.forEach(guild => {
        if (guild.reminders && guild.reminders.length > 0) {
            hasReminders = true;
            guild.reminders.forEach(rem => {
                const tr = document.createElement('tr');

                const due = new Date(rem.due_timestamp * 1000).toLocaleString();

                // Server
                const tdServer = document.createElement('td');
                tdServer.textContent = guild.name;
                tr.appendChild(tdServer);

                // User
                const tdUser = document.createElement('td');
                tdUser.textContent = rem.user_name;
                tr.appendChild(tdUser);

                // Message
                const tdMessage = document.createElement('td');
                tdMessage.textContent = rem.message;
                tr.appendChild(tdMessage);

                // Channel
                const tdChannel = document.createElement('td');
                tdChannel.textContent = rem.channel_name;
                tr.appendChild(tdChannel);

                // Due Time
                const tdDue = document.createElement('td');
                tdDue.textContent = due;
                tr.appendChild(tdDue);

                // Action
                const tdAction = document.createElement('td');
                const btn = document.createElement('button');
                btn.className = "btn btn-danger btn-sm";
                btn.textContent = "Delete";
                btn.onclick = function() { deleteReminder(guild.id, rem.id); };
                tdAction.appendChild(btn);
                tr.appendChild(tdAction);

                tbody.appendChild(tr);
            });
        }
    });

    if (!hasReminders) {
        document.getElementById('no-data-message').classList.remove('d-none');
    } else {
        document.getElementById('no-data-message').classList.add('d-none');
    }
}

async function createReminder() {
    const guildId = document.getElementById('guild-select').value;
    const channelId = document.getElementById('channel-select').value;
    const userId = document.getElementById('user-select').value;
    const duration = document.getElementById('duration-input').value.trim();
    const message = document.getElementById('message-input').value.trim();

    if (!guildId || !channelId || !userId || !duration || !message) {
        alert("Please fill in all fields.");
        return;
    }

    const btn = document.querySelector('#create-reminder-form button[type="submit"]');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = "Setting...";

    try {
        const response = await fetch('/api/reminders/create', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                guild_id: guildId,
                channel_id: channelId,
                user_id: userId,
                duration: duration,
                message: message
            })
        });

        const res = await response.json();
        if (res.status === 'success') {
            await fetchData();
            document.getElementById('message-input').value = '';
            document.getElementById('duration-input').value = '';
            alert("Reminder set successfully!");
        } else {
            alert("Error: " + res.message);
        }
    } catch (e) {
        console.error(e);
        alert("Failed to set reminder.");
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

async function deleteReminder(guildId, reminderId) {
    if (!confirm("Are you sure you want to delete this reminder?")) return;

    try {
        const response = await fetch('/api/reminders/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                guild_id: guildId,
                reminder_id: reminderId
            })
        });

        const res = await response.json();
        if (res.status === 'success') {
            await fetchData();
        } else {
            alert("Error: " + res.message);
        }
    } catch (e) {
        console.error(e);
        alert("Failed to delete reminder.");
    }
}
</script>
{% endblock %}
