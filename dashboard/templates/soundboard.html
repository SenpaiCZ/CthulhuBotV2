{% extends 'base.html' %}

{% block title %}Soundboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Soundboard</h2>
    <div>
        <a href="/admin" class="btn btn-secondary">Back to Admin</a>
    </div>
</div>

<div id="loading" class="alert alert-info">Loading soundboard data...</div>
<div id="error" class="alert alert-danger d-none"></div>

<div id="app-content" class="d-none">
    <div class="row mb-4">
        <div class="col-md-4">
            <label for="guildSelect" class="form-label">Server</label>
            <select id="guildSelect" class="form-select">
                <!-- Options populated by JS -->
            </select>
        </div>
        <div class="col-md-4">
            <label for="channelSelect" class="form-label">Voice Channel</label>
            <select id="channelSelect" class="form-select">
                <!-- Options populated by JS -->
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">Controls</label>
            <div class="d-flex gap-2">
                <button id="joinBtn" class="btn btn-success w-100">Connect</button>
                <button id="stopBtn" class="btn btn-warning w-100">Stop All</button>
                <button id="leaveBtn" class="btn btn-danger w-100">Disconnect</button>
            </div>
            <div class="mt-2">
                 <label for="volumeRange" class="form-label d-flex justify-content-between">
                    <span>Master Volume</span> <span id="volumeValue">50%</span>
                </label>
                <input type="range" class="form-range" id="volumeRange" min="0" max="100">
            </div>
        </div>
    </div>

    <div class="alert alert-info" id="statusIndicator">
        Status: <span id="connectionStatus">Disconnected</span>
    </div>

    <!-- Now Playing Section -->
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">Now Playing</div>
        <div class="card-body" id="now-playing-list">
             <div class="text-muted fst-italic">No sounds playing.</div>
        </div>
    </div>

    <div id="soundboard-files">
        <!-- Files populated by JS -->
    </div>
</div>

<script>
    let currentData = null;
    let selectedGuildId = null;

    function showError(message) {
        const errorDiv = document.getElementById('error');
        errorDiv.textContent = message;
        errorDiv.classList.remove('d-none');
        setTimeout(() => {
            errorDiv.classList.add('d-none');
        }, 5000);
    }

    async function fetchData() {
        try {
            const response = await fetch('/api/soundboard/data');
            const data = await response.json();
            currentData = data;
            render();
        } catch (e) {
            console.error(e);
            // Don't show error on every fetch fail to avoid spam, just log
        }
    }

    function render() {
        document.getElementById('loading').classList.add('d-none');
        document.getElementById('app-content').classList.remove('d-none');

        const guildSelect = document.getElementById('guildSelect');
        const channelSelect = document.getElementById('channelSelect');
        const filesContainer = document.getElementById('soundboard-files');
        const connectionStatus = document.getElementById('connectionStatus');
        const volumeRange = document.getElementById('volumeRange');
        const volumeValue = document.getElementById('volumeValue');
        const nowPlayingContainer = document.getElementById('now-playing-list');

        // Populate Guilds
        if (guildSelect.options.length === 0) {
            currentData.guilds.forEach(guild => {
                const opt = document.createElement('option');
                opt.value = guild.id;
                opt.textContent = guild.name;
                guildSelect.appendChild(opt);
            });
            if (currentData.guilds.length > 0) {
                selectedGuildId = currentData.guilds[0].id;
            }
        } else {
             if (!selectedGuildId && guildSelect.value) selectedGuildId = guildSelect.value;
        }

        if (!selectedGuildId) {
             filesContainer.innerHTML = '<div class="alert alert-warning">No servers found. Make sure the bot is in a server.</div>';
             return;
        }

        guildSelect.value = selectedGuildId;

        const guildData = currentData.guilds.find(g => g.id === selectedGuildId);
        const status = currentData.status[selectedGuildId];

        if (!guildData) return;

        // Populate Channels
        const currentChannelId = channelSelect.value;
        const newOptions = guildData.channels.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        if (channelSelect.innerHTML !== newOptions) {
             channelSelect.innerHTML = newOptions;
        }

        if (status.is_connected && status.channel_id) {
            channelSelect.value = status.channel_id;
        } else if (currentChannelId) {
             const exists = guildData.channels.find(c => c.id === currentChannelId);
             if (exists) channelSelect.value = currentChannelId;
        }

        // Update Status
        if (status.is_connected) {
            connectionStatus.textContent = `Connected to ${status.channel_id} ${status.is_playing ? '(Active)' : '(Idle)'}`;
            connectionStatus.className = status.is_playing ? 'text-success fw-bold' : 'text-primary';
        } else {
            connectionStatus.textContent = 'Disconnected';
            connectionStatus.className = 'text-muted';
        }

        // Update Master Volume
        if (document.activeElement !== volumeRange) {
             volumeRange.value = status.volume;
             volumeValue.textContent = status.volume + '%';
        }

        // --- Render Now Playing ---
        const tracks = status.tracks || [];

        if (tracks.length === 0) {
            if (!nowPlayingContainer.querySelector('.text-muted')) {
                nowPlayingContainer.innerHTML = '<div class="text-muted fst-italic">No sounds playing.</div>';
            } else {
                // Check if we need to clear zombie elements if any
                 if (nowPlayingContainer.children.length > 1) nowPlayingContainer.innerHTML = '<div class="text-muted fst-italic">No sounds playing.</div>';
            }
        } else {
            // Map existing
            const existingMap = {};
            nowPlayingContainer.querySelectorAll('[data-track-id]').forEach(el => {
                existingMap[el.dataset.trackId] = el;
            });

            // Remove tracks not in list
            const newIds = new Set(tracks.map(t => t.id));
            Object.keys(existingMap).forEach(id => {
                if (!newIds.has(id)) existingMap[id].remove();
            });

            // Remove placeholder if exists
            if (nowPlayingContainer.querySelector('.text-muted')) {
                nowPlayingContainer.innerHTML = '';
            }

            tracks.forEach(track => {
                let el = existingMap[track.id];
                if (!el) {
                    el = document.createElement('div');
                    el.className = 'd-flex justify-content-between align-items-center mb-2 border-bottom pb-2';
                    el.dataset.trackId = track.id;
                    el.innerHTML = `
                        <div class="fw-bold text-truncate me-2" style="max-width: 200px;" title="${track.name}">${track.name}</div>
                        <div class="d-flex gap-2 align-items-center flex-wrap justify-content-end">
                            <div class="d-flex align-items-center" title="Volume">
                                <span class="small me-1">Vol</span>
                                <input type="range" class="form-range mx-1 track-vol" style="width: 80px;" min="0" max="100">
                            </div>

                            <div class="form-check form-switch pt-1" title="Loop">
                                 <input class="form-check-input track-loop" type="checkbox">
                                 <label class="form-check-label small">Loop</label>
                            </div>

                            <button class="btn btn-sm btn-outline-warning track-pause" style="width: 40px;" title="Pause/Resume">
                                ⏸
                            </button>

                            <button class="btn btn-sm btn-outline-danger track-remove" title="Stop">
                                ❌
                            </button>
                        </div>
                    `;
                    nowPlayingContainer.appendChild(el);

                    // Initial Listeners
                    el.querySelector('.track-vol').onchange = (e) => updateTrackVolume(track.id, e.target.value);
                    el.querySelector('.track-loop').onchange = (e) => updateTrackLoop(track.id, e.target.checked);
                    el.querySelector('.track-remove').onclick = () => removeTrack(track.id);
                }

                // Update UI state
                const volInput = el.querySelector('.track-vol');
                if (document.activeElement !== volInput) {
                    volInput.value = track.volume;
                }

                const loopInput = el.querySelector('.track-loop');
                loopInput.checked = track.loop;

                const pauseBtn = el.querySelector('.track-pause');
                pauseBtn.innerText = track.paused ? '▶' : '⏸';
                pauseBtn.onclick = () => updateTrackPause(track.id, !track.paused);
                pauseBtn.className = track.paused ? 'btn btn-sm btn-outline-success track-pause' : 'btn btn-sm btn-outline-warning track-pause';
            });
        }


        // --- Render Files ---
        if (filesContainer.childElementCount === 0) {
             filesContainer.innerHTML = '';

            const createGrid = (files, folderColor) => {
                const container = document.createElement('div');
                container.className = 'container-fluid p-3';
                const row = document.createElement('div');
                row.className = 'row g-3';

                files.forEach(file => {
                    const col = document.createElement('div');
                    col.className = 'col-6 col-md-4 col-lg-3'; // Responsive grid: 2 cols mobile, 3 tablet, 4 desktop

                    // Fetch saved settings for this file
                    const fileSettings = currentData.settings?.files?.[file.path] || {};
                    const savedVol = fileSettings.volume !== undefined ? fileSettings.volume : 100;
                    const savedLoop = fileSettings.loop !== undefined ? fileSettings.loop : false;
                    const safePath = file.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'");

                    col.innerHTML = `
                        <div class="card h-100 shadow-sm sound-card" style="cursor: pointer; transition: transform 0.1s;">
                            <div class="card-body d-flex flex-column justify-content-between p-2" style="background-color: ${folderColor || '#f8f9fa'}; min-height: 100px;">
                                <h6 class="card-title text-center text-truncate fw-bold mb-2" title="${file.name}" style="pointer-events: none; user-select: none; text-shadow: 0 1px 3px rgba(0,0,0,0.8); color: white;">
                                    ${file.name}
                                </h6>
                            </div>
                            <div class="card-footer p-2 bg-light d-flex align-items-center justify-content-between stop-prop">
                                <div class="d-flex align-items-center flex-grow-1 me-2" title="Volume">
                                    <input type="range" class="form-range sound-vol" min="0" max="100" value="${savedVol}" data-path="${safePath}">
                                </div>
                                <div class="form-check form-switch m-0" title="Loop">
                                    <input class="form-check-input sound-loop" type="checkbox" ${savedLoop ? 'checked' : ''} data-path="${safePath}">
                                </div>
                            </div>
                        </div>
                    `;

                    // Add click listener to card body (play)
                    const card = col.querySelector('.sound-card');
                    card.onclick = (e) => {
                        // If clicking controls, do nothing (handled by stop-prop logic but double check)
                        if (e.target.closest('.stop-prop')) return;

                        // Animate click
                        card.style.transform = "scale(0.95)";
                        setTimeout(() => card.style.transform = "scale(1)", 100);

                        // Get current UI values
                        const volInput = col.querySelector('.sound-vol');
                        const loopInput = col.querySelector('.sound-loop');
                        const vol = parseInt(volInput.value);
                        const loop = loopInput.checked;

                        playSound(file.path, loop, vol);
                    };

                    // Add listeners to controls to save settings
                    const volInput = col.querySelector('.sound-vol');
                    const loopInput = col.querySelector('.sound-loop');

                    // Stop propagation to prevent play on control click
                    col.querySelector('.stop-prop').onclick = (e) => e.stopPropagation();

                    volInput.onchange = (e) => {
                        saveFileSettings(file.path, parseInt(e.target.value), loopInput.checked);
                    };
                    // Also prevent drag from triggering click if possible, mostly handled by stopPropagation on click

                    loopInput.onchange = (e) => {
                        saveFileSettings(file.path, parseInt(volInput.value), e.target.checked);
                    };

                    row.appendChild(col);
                });
                container.appendChild(row);
                return container;
            };

            if (currentData.files.Root) {
                const rootCard = document.createElement('div');
                rootCard.className = 'card mb-3';
                rootCard.innerHTML = '<div class="card-header">Uncategorized</div><div class="card-body p-0" id="root-files"></div>';
                filesContainer.appendChild(rootCard);
                const rootBody = rootCard.querySelector('#root-files');
                rootBody.appendChild(createGrid(currentData.files.Root, '#ffffff'));
            }

            Object.keys(currentData.files).forEach((key, index) => {
                if (key === 'Root') return;

                const safeKey = `folder-${index}`;
                const folderColor = currentData.settings?.folder_colors?.[key] || '';

                const card = document.createElement('div');
                card.className = 'card mb-3';

                const headerStyle = folderColor ? `style="background-color: ${folderColor};"` : '';

                card.innerHTML = `
                    <div class="card-header d-flex justify-content-between align-items-center" ${headerStyle}>
                        <button class="btn btn-link text-decoration-none text-reset fw-bold p-0" type="button" data-bs-toggle="collapse" data-bs-target="#${safeKey}">
                            ${key} <span class="small">▼</span>
                        </button>
                        <input type="color" class="form-control form-control-color form-control-sm" value="${folderColor || '#f8f9fa'}" title="Choose folder color">
                    </div>
                    <div id="${safeKey}" class="collapse show">
                        <div class="card-body p-0" id="body-${safeKey}"></div>
                    </div>
                `;
                filesContainer.appendChild(card);

                // Color Picker Logic
                const colorInput = card.querySelector('input[type="color"]');
                colorInput.onchange = (e) => {
                    const newColor = e.target.value;
                    card.querySelector('.card-header').style.backgroundColor = newColor;
                    saveFolderColor(key, newColor);
                };
                // Prevent collapse when clicking color picker
                colorInput.onclick = (e) => e.stopPropagation();

                const body = card.querySelector(`#body-${safeKey}`);
                body.appendChild(createGrid(currentData.files[key], folderColor));
            });

            if (Object.keys(currentData.files).length === 0) {
                 filesContainer.innerHTML = '<div class="alert alert-secondary">No sound files found.</div>';
            }
        }
    }

    async function saveFolderColor(folderName, color) {
        await apiCall('/api/soundboard/folder/color', { folder_name: folderName, color: color });
    }

    async function saveFileSettings(filePath, volume, loop) {
        await apiCall('/api/soundboard/file/settings', {
            file_path: filePath,
            volume: volume,
            loop: loop
        });
        // We do NOT call fetchData() here to avoid refreshing the UI and disrupting the user interaction (e.g. dragging slider)
        // Update local data cache instead if needed, but UI is already authoritative for current state.
    }

    // --- Actions ---

    document.getElementById('guildSelect').onchange = (e) => {
        selectedGuildId = e.target.value;
        if (currentData && currentData.status[selectedGuildId]) {
             const vol = currentData.status[selectedGuildId].volume;
             document.getElementById('volumeRange').value = vol;
             document.getElementById('volumeValue').textContent = vol + '%';
        }
        render();
    };

    document.getElementById('joinBtn').onclick = async () => {
        if (!selectedGuildId) return;
        const channelId = document.getElementById('channelSelect').value;
        if (!channelId) { showError("Please select a voice channel!"); return; }
        await apiCall('/api/soundboard/join', { guild_id: selectedGuildId, channel_id: channelId });
    };

    document.getElementById('leaveBtn').onclick = async () => {
        if (!selectedGuildId) return;
        await apiCall('/api/soundboard/leave', { guild_id: selectedGuildId });
    };

    document.getElementById('stopBtn').onclick = async () => {
        if (!selectedGuildId) return;
        await apiCall('/api/soundboard/stop', { guild_id: selectedGuildId });
    };

    document.getElementById('volumeRange').oninput = (e) => {
        document.getElementById('volumeValue').textContent = e.target.value + '%';
    };

    document.getElementById('volumeRange').onchange = async (e) => {
        if (!selectedGuildId) return;
        await apiCall('/api/soundboard/volume', { guild_id: selectedGuildId, volume: parseInt(e.target.value) });
    };

    async function playSound(filePath, loop, volume) {
        if (!selectedGuildId) return;
        const channelId = document.getElementById('channelSelect').value;
        if (!channelId) { showError("Please select a voice channel!"); return; }

        // Convert 0-100 volume to 0.0-1.0 modifier
        const modifier = volume / 100.0;

        await apiCall('/api/soundboard/play', {
             guild_id: selectedGuildId,
             channel_id: channelId,
             file_path: filePath,
             loop: loop,
             volume_modifier: modifier
        });
    }

    // Track Actions
    async function updateTrackVolume(trackId, vol) {
        if (!selectedGuildId) return;
        await apiCall('/api/soundboard/track/volume', { guild_id: selectedGuildId, track_id: trackId, volume: parseInt(vol) });
    }

    async function updateTrackLoop(trackId, loop) {
        if (!selectedGuildId) return;
        await apiCall('/api/soundboard/track/loop', { guild_id: selectedGuildId, track_id: trackId, loop: loop });
    }

    async function updateTrackPause(trackId, paused) {
        if (!selectedGuildId) return;
        await apiCall('/api/soundboard/track/pause', { guild_id: selectedGuildId, track_id: trackId, paused: paused });
    }

    async function removeTrack(trackId) {
        if (!selectedGuildId) return;
        await apiCall('/api/soundboard/track/remove', { guild_id: selectedGuildId, track_id: trackId });
    }

    async function apiCall(url, body) {
        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            const data = await res.json();
            if (data.status === 'error') {
                showError(data.message);
            } else {
                fetchData();
            }
        } catch (e) {
            showError("API Error: " + e);
        }
    }

    fetchData();
    setInterval(fetchData, 3000);

</script>
{% endblock %}
